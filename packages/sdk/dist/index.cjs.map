{"version":3,"sources":["../src/index.ts","../src/types/knowledge-unit.ts","../src/types/zod-schemas.ts","../src/hnsw-cache.ts","../src/scoring.ts","../src/utils/id.ts","../src/capture.ts","../src/retrieve.ts","../src/errors.ts","../src/utils/hash.ts","../src/contribute.ts","../src/skill-md.ts","../src/utils/sanitizer.ts","../src/migrations/types.ts","../src/migrations/v1-to-v2.ts","../src/migrations/index.ts","../src/reputation/eigentrust.ts","../src/reputation/verifiable-credential.ts"],"sourcesContent":["// Types\nexport {\n  KP_CONTEXT,\n  type KnowledgeUnit,\n  type KnowledgeUnitMeta,\n  type KnowledgeUnitType,\n  type PrivacyLevel,\n  type Visibility,\n  type ReasoningTrace,\n  type ReasoningTraceStep,\n  type ToolCallPattern,\n  type ExpertSOP,\n  type SkillMdFrontmatter,\n  type SkillMdKpExtension,\n} from \"./types/index.js\";\n\n// Zod Schemas\nexport {\n  KnowledgeUnitSchema,\n  KnowledgeUnitTypeSchema,\n  KnowledgeUnitMetaSchema,\n  PrivacyLevelSchema,\n  VisibilitySchema,\n  ReasoningTraceSchema,\n  ReasoningTraceStepSchema,\n  ToolCallPatternSchema,\n  ExpertSOPSchema,\n  SkillMdFrontmatterSchema,\n  SkillMdKpExtensionSchema,\n} from \"./types/index.js\";\n\n// Core APIs\nexport { KPCapture, type CaptureConfig } from \"./capture.js\";\nexport { KPRetrieval, type RetrievalConfig } from \"./retrieve.js\";\nexport { contributeKnowledge, contributeSkill, type ContributeConfig } from \"./contribute.js\";\nexport { evaluateValue } from \"./scoring.js\";\nexport { VectorCache } from \"./hnsw-cache.js\";\n\n// Skill.md\nexport { parseSkillMd, generateSkillMd, validateSkillMd, type ParsedSkillMd } from \"./skill-md.js\";\n\n// Utilities\nexport {\n  generateTraceId,\n  generatePatternId,\n  generateSopId,\n  generateSkillId,\n  sha256,\n  sanitizeSkillMd,\n  type SanitizeResult,\n} from \"./utils/index.js\";\n\n// Errors\nexport {\n  KPError,\n  ValidationError,\n  SanitizationError,\n  AuthenticationError,\n  RateLimitError,\n  NotFoundError,\n} from \"./errors.js\";\n\n// Migrations\nexport { migrate } from \"./migrations/index.js\";\n\n// Reputation\nexport {\n  computeEigenTrust,\n  createCredential,\n  generateKeyPair,\n  signCredential,\n  verifyCredential,\n  type KeyPair,\n  type ValidationVote,\n  type TrustEdge,\n  type EigenTrustConfig,\n  type EigenTrustResult,\n  type ReputationCredential,\n} from \"./reputation/index.js\";\n","/**\n * KnowledgePulse Knowledge Unit Type Definitions\n * Single Source of Truth — JSON Schema generated via `bun run codegen`\n */\n\nexport const KP_CONTEXT = \"https://knowledgepulse.dev/schema/v1\" as const;\n\nexport type KnowledgeUnitType = \"ReasoningTrace\" | \"ToolCallPattern\" | \"ExpertSOP\";\n\nexport type PrivacyLevel = \"aggregated\" | \"federated\" | \"private\";\nexport type Visibility = \"private\" | \"org\" | \"network\";\n\nexport interface KnowledgeUnitMeta {\n  created_at: string; // ISO 8601\n  agent_id?: string; // kp:agent:<id>\n  framework?: string; // langgraph | crewai | autogen | openclaw\n  task_domain: string;\n  success: boolean;\n  quality_score: number; // 0.0 ~ 1.0\n  visibility: Visibility;\n  privacy_level: PrivacyLevel;\n  validated_by?: string[]; // kp:validator:<id>[]\n}\n\nexport interface ReasoningTraceStep {\n  step_id: number;\n  type: \"thought\" | \"tool_call\" | \"observation\" | \"error_recovery\";\n  content?: string;\n  tool?: { name: string; mcp_server?: string };\n  input?: Record<string, unknown>;\n  output_summary?: string;\n  latency_ms?: number;\n}\n\nexport interface ReasoningTrace {\n  \"@context\": typeof KP_CONTEXT;\n  \"@type\": \"ReasoningTrace\";\n  id: string; // kp:trace:<uuid>\n  source_skill?: string; // kp:skill:<name>:<version>\n  metadata: KnowledgeUnitMeta;\n  task: {\n    objective: string;\n    input_schema?: Record<string, unknown>;\n  };\n  steps: ReasoningTraceStep[];\n  outcome: {\n    result_summary: string;\n    confidence: number;\n  };\n  knowledge_graph_delta?: {\n    entities: Array<{ name: string; type: string }>;\n    relationships: Array<{ fact: string; valid_from: string }>;\n  };\n}\n\nexport interface ToolCallPattern {\n  \"@context\": typeof KP_CONTEXT;\n  \"@type\": \"ToolCallPattern\";\n  id: string; // kp:pattern:<uuid>\n  name: string;\n  description: string;\n  metadata: KnowledgeUnitMeta;\n  trigger_conditions: {\n    task_types: string[];\n    required_tools?: string[];\n  };\n  tool_sequence: Array<{\n    step: string;\n    execution: \"parallel\" | \"sequential\";\n    tools: Array<{\n      name: string;\n      query_template?: string;\n      input_template?: Record<string, unknown>;\n    }>;\n    condition?: string;\n  }>;\n  performance: {\n    avg_ms: number;\n    success_rate: number;\n    uses: number;\n  };\n}\n\nexport interface ExpertSOP {\n  \"@context\": typeof KP_CONTEXT;\n  \"@type\": \"ExpertSOP\";\n  id: string; // kp:sop:<uuid>\n  name: string;\n  domain: string;\n  metadata: KnowledgeUnitMeta;\n  source: {\n    type: \"human_expert\";\n    expert_id: string;\n    credentials: string[]; // kp:sbt:<cert>[]\n  };\n  decision_tree: Array<{\n    step: string;\n    instruction: string;\n    criteria?: Record<string, string>;\n    conditions?: Record<string, { action: string; sla_min?: number }>;\n    tool_suggestions?: Array<{ name: string; when: string }>;\n  }>;\n  validation?: {\n    test_cases: Array<{\n      input: Record<string, unknown>;\n      expected_output: Record<string, unknown>;\n    }>;\n  };\n}\n\nexport type KnowledgeUnit = ReasoningTrace | ToolCallPattern | ExpertSOP;\n\n/** SKILL.md standard frontmatter fields */\nexport interface SkillMdFrontmatter {\n  name: string;\n  description: string;\n  version?: string;\n  author?: string;\n  license?: string;\n  tags?: string[];\n  \"allowed-tools\"?: string[];\n}\n\n/** KnowledgePulse extension fields for SKILL.md */\nexport interface SkillMdKpExtension {\n  knowledge_capture?: boolean;\n  domain?: string;\n  quality_threshold?: number;\n  privacy_level?: PrivacyLevel;\n  visibility?: Visibility;\n  reward_eligible?: boolean;\n}\n","import { z } from \"zod\";\nimport { KP_CONTEXT } from \"./knowledge-unit.js\";\n\n// ── Enums ──────────────────────────────────────────────\n\nexport const KnowledgeUnitTypeSchema = z.enum([\"ReasoningTrace\", \"ToolCallPattern\", \"ExpertSOP\"]);\n\nexport const PrivacyLevelSchema = z.enum([\"aggregated\", \"federated\", \"private\"]);\nexport const VisibilitySchema = z.enum([\"private\", \"org\", \"network\"]);\n\n// ── KnowledgeUnitMeta ──────────────────────────────────\n\nexport const KnowledgeUnitMetaSchema = z.object({\n  created_at: z.string().datetime(),\n  agent_id: z.string().optional(),\n  framework: z.string().optional(),\n  task_domain: z.string().min(1),\n  success: z.boolean(),\n  quality_score: z.number().min(0).max(1),\n  visibility: VisibilitySchema,\n  privacy_level: PrivacyLevelSchema,\n  validated_by: z.array(z.string()).optional(),\n});\n\n// ── ReasoningTrace ─────────────────────────────────────\n\nexport const ReasoningTraceStepSchema = z.object({\n  step_id: z.number().int().nonnegative(),\n  type: z.enum([\"thought\", \"tool_call\", \"observation\", \"error_recovery\"]),\n  content: z.string().optional(),\n  tool: z\n    .object({\n      name: z.string(),\n      mcp_server: z.string().optional(),\n    })\n    .optional(),\n  input: z.record(z.unknown()).optional(),\n  output_summary: z.string().optional(),\n  latency_ms: z.number().nonnegative().optional(),\n});\n\nexport const ReasoningTraceSchema = z.object({\n  \"@context\": z.literal(KP_CONTEXT),\n  \"@type\": z.literal(\"ReasoningTrace\"),\n  id: z.string().startsWith(\"kp:trace:\"),\n  source_skill: z.string().optional(),\n  metadata: KnowledgeUnitMetaSchema,\n  task: z.object({\n    objective: z.string().min(1),\n    input_schema: z.record(z.unknown()).optional(),\n  }),\n  steps: z.array(ReasoningTraceStepSchema).min(1),\n  outcome: z.object({\n    result_summary: z.string(),\n    confidence: z.number().min(0).max(1),\n  }),\n  knowledge_graph_delta: z\n    .object({\n      entities: z.array(z.object({ name: z.string(), type: z.string() })),\n      relationships: z.array(z.object({ fact: z.string(), valid_from: z.string() })),\n    })\n    .optional(),\n});\n\n// ── ToolCallPattern ────────────────────────────────────\n\nexport const ToolCallPatternSchema = z.object({\n  \"@context\": z.literal(KP_CONTEXT),\n  \"@type\": z.literal(\"ToolCallPattern\"),\n  id: z.string().startsWith(\"kp:pattern:\"),\n  name: z.string().min(1),\n  description: z.string(),\n  metadata: KnowledgeUnitMetaSchema,\n  trigger_conditions: z.object({\n    task_types: z.array(z.string()).min(1),\n    required_tools: z.array(z.string()).optional(),\n  }),\n  tool_sequence: z\n    .array(\n      z.object({\n        step: z.string(),\n        execution: z.enum([\"parallel\", \"sequential\"]),\n        tools: z.array(\n          z.object({\n            name: z.string(),\n            query_template: z.string().optional(),\n            input_template: z.record(z.unknown()).optional(),\n          }),\n        ),\n        condition: z.string().optional(),\n      }),\n    )\n    .min(1),\n  performance: z.object({\n    avg_ms: z.number().nonnegative(),\n    success_rate: z.number().min(0).max(1),\n    uses: z.number().int().nonnegative(),\n  }),\n});\n\n// ── ExpertSOP ──────────────────────────────────────────\n\nexport const ExpertSOPSchema = z.object({\n  \"@context\": z.literal(KP_CONTEXT),\n  \"@type\": z.literal(\"ExpertSOP\"),\n  id: z.string().startsWith(\"kp:sop:\"),\n  name: z.string().min(1),\n  domain: z.string().min(1),\n  metadata: KnowledgeUnitMetaSchema,\n  source: z.object({\n    type: z.literal(\"human_expert\"),\n    expert_id: z.string(),\n    credentials: z.array(z.string()),\n  }),\n  decision_tree: z\n    .array(\n      z.object({\n        step: z.string(),\n        instruction: z.string(),\n        criteria: z.record(z.string()).optional(),\n        conditions: z\n          .record(\n            z.object({\n              action: z.string(),\n              sla_min: z.number().optional(),\n            }),\n          )\n          .optional(),\n        tool_suggestions: z.array(z.object({ name: z.string(), when: z.string() })).optional(),\n      }),\n    )\n    .min(1),\n  validation: z\n    .object({\n      test_cases: z.array(\n        z.object({\n          input: z.record(z.unknown()),\n          expected_output: z.record(z.unknown()),\n        }),\n      ),\n    })\n    .optional(),\n});\n\n// ── Discriminated Union ────────────────────────────────\n\nexport const KnowledgeUnitSchema = z.discriminatedUnion(\"@type\", [\n  ReasoningTraceSchema,\n  ToolCallPatternSchema,\n  ExpertSOPSchema,\n]);\n\n// ── SKILL.md Schemas ───────────────────────────────────\n\nexport const SkillMdFrontmatterSchema = z.object({\n  name: z.string().min(1),\n  description: z.string().min(1),\n  version: z.string().optional(),\n  author: z.string().optional(),\n  license: z.string().optional(),\n  tags: z.array(z.string()).optional(),\n  \"allowed-tools\": z.array(z.string()).optional(),\n});\n\nexport const SkillMdKpExtensionSchema = z.object({\n  knowledge_capture: z.boolean().optional(),\n  domain: z.string().optional(),\n  quality_threshold: z.number().min(0).max(1).optional(),\n  privacy_level: PrivacyLevelSchema.optional(),\n  visibility: VisibilitySchema.optional(),\n  reward_eligible: z.boolean().optional(),\n});\n","/**\n * VectorCache — Brute-force linear scan for cosine similarity.\n * 1,000 x 384-dim vectors = sub-1ms scan. Interface supports future HNSW swap.\n */\n\n/** Internal entry that pairs a vector with its insertion timestamp. */\ninterface CacheEntry {\n  vector: Float32Array;\n  addedAt: number;\n}\n\nexport class VectorCache {\n  private entries: CacheEntry[] = [];\n  private readonly maxElements: number;\n  private readonly dimensions: number;\n  private readonly ttlMs: number | null;\n\n  constructor(opts: { maxElements?: number; dimensions?: number; ttlMs?: number } = {}) {\n    this.maxElements = opts.maxElements ?? 1000;\n    this.dimensions = opts.dimensions ?? 384;\n    this.ttlMs = opts.ttlMs ?? null;\n  }\n\n  get size(): number {\n    this.evictExpired();\n    return this.entries.length;\n  }\n\n  add(vector: ArrayLike<number>): void {\n    if (vector.length !== this.dimensions) {\n      throw new Error(`Expected ${this.dimensions} dimensions, got ${vector.length}`);\n    }\n    const v = vector instanceof Float32Array ? vector : new Float32Array(vector);\n    this.entries.push({ vector: v, addedAt: Date.now() });\n\n    // Evict oldest if over capacity\n    if (this.entries.length > this.maxElements) {\n      this.entries.shift();\n    }\n  }\n\n  /** Remove entries older than `ttlMs`. No-op when TTL is not configured. */\n  evictExpired(): void {\n    if (this.ttlMs === null) return;\n    const now = Date.now();\n    const cutoff = now - this.ttlMs;\n    this.entries = this.entries.filter((e) => e.addedAt > cutoff);\n  }\n\n  maxCosineSimilarity(query: ArrayLike<number>): number {\n    this.evictExpired();\n    if (this.entries.length === 0) return 0;\n\n    const q = query instanceof Float32Array ? query : new Float32Array(query);\n    let maxSim = -1;\n\n    for (const entry of this.entries) {\n      const sim = cosineSimilarity(q, entry.vector);\n      if (sim > maxSim) maxSim = sim;\n    }\n\n    return maxSim;\n  }\n\n  clear(): void {\n    this.entries = [];\n  }\n}\n\nfunction cosineSimilarity(a: Float32Array, b: Float32Array): number {\n  let dot = 0;\n  let normA = 0;\n  let normB = 0;\n\n  for (let i = 0; i < a.length; i++) {\n    dot += a[i]! * b[i]!;\n    normA += a[i]! * a[i]!;\n    normB += b[i]! * b[i]!;\n  }\n\n  const denom = Math.sqrt(normA) * Math.sqrt(normB);\n  return denom === 0 ? 0 : dot / denom;\n}\n","import { VectorCache } from \"./hnsw-cache.js\";\nimport type { ReasoningTrace } from \"./types/knowledge-unit.js\";\n\nexport interface ScoringWeights {\n  complexity: number;\n  novelty: number;\n  toolDiversity: number;\n  outcomeConfidence: number;\n}\n\nconst DEFAULT_WEIGHTS: ScoringWeights = {\n  complexity: 0.25,\n  novelty: 0.35,\n  toolDiversity: 0.15,\n  outcomeConfidence: 0.25,\n};\n\nconst DOMAIN_WEIGHTS: Record<string, ScoringWeights> = {\n  finance: { complexity: 0.20, novelty: 0.25, toolDiversity: 0.10, outcomeConfidence: 0.45 },\n  code: { complexity: 0.20, novelty: 0.30, toolDiversity: 0.30, outcomeConfidence: 0.20 },\n  medical: { complexity: 0.15, novelty: 0.20, toolDiversity: 0.10, outcomeConfidence: 0.55 },\n  customer_service: { complexity: 0.20, novelty: 0.30, toolDiversity: 0.20, outcomeConfidence: 0.30 },\n};\n\nfunction getWeights(domain: string): ScoringWeights {\n  return DOMAIN_WEIGHTS[domain] ?? DEFAULT_WEIGHTS;\n}\n\nconst localCache = new VectorCache({ maxElements: 1000, dimensions: 384 });\n\n// Lazy-loaded embedder (avoids 80MB import on startup)\nlet embedderPromise: Promise<((text: string) => Promise<Float32Array>) | null> | null = null;\n\nasync function getEmbedder(): Promise<((text: string) => Promise<Float32Array>) | null> {\n  if (embedderPromise) return embedderPromise;\n\n  embedderPromise = (async () => {\n    try {\n      const { pipeline } = await import(\"@huggingface/transformers\");\n      const pipe = await pipeline(\"feature-extraction\", \"Xenova/all-MiniLM-L6-v2\");\n      return async (text: string): Promise<Float32Array> => {\n        const result = await pipe(text, { pooling: \"mean\", normalize: true });\n        return new Float32Array(result.data as ArrayLike<number>);\n      };\n    } catch {\n      // @huggingface/transformers not available — fallback to no-embedding mode\n      return null;\n    }\n  })();\n\n  return embedderPromise;\n}\n\nexport async function evaluateValue(trace: ReasoningTrace): Promise<number> {\n  const { steps, outcome, task } = trace;\n\n  // ── Complexity (C) ──\n  const uniqueTypes = new Set(steps.map((s) => s.type)).size;\n  const errorRecovery = steps.filter((s) => s.type === \"error_recovery\").length;\n  const C = Math.min(\n    1.0,\n    (uniqueTypes / 4) * 0.5 + (errorRecovery > 0 ? 0.3 : 0) + (steps.length / 20) * 0.2,\n  );\n\n  // ── Novelty (N) ──\n  let N = 0.5; // default when no embedder or empty cache\n  const embedder = await getEmbedder();\n  if (embedder) {\n    const text = `${task.objective} ${steps.map((s) => s.content ?? \"\").join(\" \")}`;\n    const embedding = await embedder(text);\n    N = localCache.size > 0 ? 1.0 - localCache.maxCosineSimilarity(embedding) : 0.5;\n    // Update local cache for subsequent novelty calculations\n    localCache.add(embedding);\n  }\n\n  // ── Tool Diversity (D) ──\n  const uniqueTools = new Set(steps.filter((s) => s.tool).map((s) => s.tool?.name)).size;\n  const D = Math.min(1.0, (uniqueTools / Math.max(1, steps.length)) * 3);\n\n  // ── Outcome Confidence (O) ──\n  const O = outcome.confidence * (trace.metadata.success ? 1.0 : 0.3);\n\n  // ── Composite Score ──\n  const w = getWeights(trace.metadata.task_domain);\n  let score = C * w.complexity + N * w.novelty + D * w.toolDiversity + O * w.outcomeConfidence;\n\n  // ── Rule-based Overrides ──\n  if (steps.length === 1 && steps[0]?.type === \"thought\") score = 0.1;\n  if (errorRecovery > 2 && trace.metadata.success) score = Math.min(1.0, score + 0.1);\n  if (uniqueTools <= 1 && steps.some((s) => s.tool)) score = Math.max(0.0, score - 0.1);\n\n  return score;\n}\n\n/** Expose cache for testing */\nexport function _getLocalCache(): VectorCache {\n  return localCache;\n}\n","function uuid(): string {\n  return crypto.randomUUID();\n}\n\nexport function generateTraceId(): string {\n  return `kp:trace:${uuid()}`;\n}\n\nexport function generatePatternId(): string {\n  return `kp:pattern:${uuid()}`;\n}\n\nexport function generateSopId(): string {\n  return `kp:sop:${uuid()}`;\n}\n\nexport function generateSkillId(): string {\n  return `kp:skill:${uuid()}`;\n}\n","import { evaluateValue } from \"./scoring.js\";\nimport type {\n  PrivacyLevel,\n  ReasoningTrace,\n  ReasoningTraceStep,\n  Visibility,\n} from \"./types/knowledge-unit.js\";\nimport { KP_CONTEXT } from \"./types/knowledge-unit.js\";\nimport { generateTraceId } from \"./utils/id.js\";\n\nexport interface CaptureConfig {\n  autoCapture?: boolean; // default true\n  valueThreshold?: number; // default 0.75\n  privacyLevel?: PrivacyLevel; // default \"aggregated\"\n  visibility?: Visibility; // default \"network\"\n  domain: string; // required\n  registryUrl?: string; // default https://registry.knowledgepulse.dev\n  apiKey?: string;\n}\n\nexport class KPCapture {\n  private config: Required<\n    Pick<CaptureConfig, \"autoCapture\" | \"valueThreshold\" | \"privacyLevel\" | \"visibility\" | \"domain\">\n  > &\n    CaptureConfig;\n\n  constructor(config: CaptureConfig) {\n    this.config = {\n      autoCapture: true,\n      valueThreshold: 0.75,\n      privacyLevel: \"aggregated\",\n      visibility: \"network\",\n      ...config,\n    };\n  }\n\n  /**\n   * Wrap an agent function to transparently capture knowledge.\n   * The wrapper records execution trace, scores it, and async-contributes if above threshold.\n   */\n  wrap<T extends (...args: unknown[]) => Promise<unknown>>(agentFn: T): T {\n    return (async (...args: unknown[]) => {\n      if (!this.config.autoCapture) {\n        return agentFn(...args);\n      }\n\n      const traceId = generateTraceId();\n      const startTime = Date.now();\n      const steps: ReasoningTraceStep[] = [];\n\n      // Record a thought step with the input\n      steps.push({\n        step_id: 0,\n        type: \"thought\",\n        content: `Executing with args: ${JSON.stringify(args).slice(0, 200)}`,\n      });\n\n      let success = true;\n      let result: unknown;\n      try {\n        result = await agentFn(...args);\n        steps.push({\n          step_id: steps.length,\n          type: \"observation\",\n          content: \"Execution completed successfully\",\n          latency_ms: Date.now() - startTime,\n        });\n      } catch (error) {\n        success = false;\n        steps.push({\n          step_id: steps.length,\n          type: \"error_recovery\",\n          content: `Error: ${error instanceof Error ? error.message : String(error)}`,\n          latency_ms: Date.now() - startTime,\n        });\n        throw error;\n      } finally {\n        // Fire-and-forget: score and contribute asynchronously\n        const trace: ReasoningTrace = {\n          \"@context\": KP_CONTEXT,\n          \"@type\": \"ReasoningTrace\",\n          id: traceId,\n          metadata: {\n            created_at: new Date().toISOString(),\n            task_domain: this.config.domain,\n            success,\n            quality_score: 0, // placeholder, scored below\n            visibility: this.config.visibility,\n            privacy_level: this.config.privacyLevel,\n          },\n          task: {\n            objective: `Agent execution in ${this.config.domain}`,\n          },\n          steps,\n          outcome: {\n            result_summary: success ? \"Completed\" : \"Failed\",\n            confidence: success ? 0.8 : 0.2,\n          },\n        };\n\n        // Non-blocking scoring + contribution\n        void this.scoreAndContribute(trace).catch(() => {\n          // Silently ignore — must not affect agent execution\n        });\n      }\n\n      return result;\n    }) as T;\n  }\n\n  private async scoreAndContribute(trace: ReasoningTrace): Promise<void> {\n    const score = await evaluateValue(trace);\n    trace.metadata.quality_score = score;\n\n    if (score < this.config.valueThreshold) return;\n\n    const url = this.config.registryUrl ?? \"https://registry.knowledgepulse.dev\";\n    const headers: Record<string, string> = {\n      \"Content-Type\": \"application/json\",\n    };\n    if (this.config.apiKey) {\n      headers.Authorization = `Bearer ${this.config.apiKey}`;\n    }\n\n    await fetch(`${url}/v1/knowledge`, {\n      method: \"POST\",\n      headers,\n      body: JSON.stringify(trace),\n    });\n  }\n}\n","import type {\n  ExpertSOP,\n  KnowledgeUnit,\n  KnowledgeUnitType,\n  ReasoningTrace,\n  ToolCallPattern,\n} from \"./types/knowledge-unit.js\";\n\nexport interface RetrievalConfig {\n  minQuality?: number; // default 0.80\n  knowledgeTypes?: KnowledgeUnitType[];\n  limit?: number; // default 5\n  registryUrl?: string;\n  apiKey?: string;\n}\n\nexport class KPRetrieval {\n  private config: RetrievalConfig;\n\n  constructor(config: RetrievalConfig = {}) {\n    this.config = config;\n  }\n\n  async search(query: string, domain?: string): Promise<KnowledgeUnit[]> {\n    const params = new URLSearchParams({\n      q: query,\n      min_quality: String(this.config.minQuality ?? 0.8),\n      limit: String(this.config.limit ?? 5),\n    });\n    if (domain) params.set(\"domain\", domain);\n    if (this.config.knowledgeTypes) {\n      params.set(\"types\", this.config.knowledgeTypes.join(\",\"));\n    }\n\n    const url = this.config.registryUrl ?? \"https://registry.knowledgepulse.dev\";\n    const headers: Record<string, string> = {};\n    if (this.config.apiKey) {\n      headers.Authorization = `Bearer ${this.config.apiKey}`;\n    }\n\n    const res = await fetch(`${url}/v1/knowledge?${params}`, { headers });\n    const body = (await res.json()) as { data: KnowledgeUnit[] };\n    return body.data;\n  }\n\n  async searchSkills(\n    query: string,\n    opts?: { domain?: string; tags?: string[]; limit?: number },\n  ): Promise<unknown[]> {\n    const params = new URLSearchParams({\n      q: query,\n      limit: String(opts?.limit ?? this.config.limit ?? 5),\n    });\n    if (opts?.domain) params.set(\"domain\", opts.domain);\n    if (opts?.tags?.length) params.set(\"tags\", opts.tags.join(\",\"));\n\n    const url = this.config.registryUrl ?? \"https://registry.knowledgepulse.dev\";\n    const headers: Record<string, string> = {};\n    if (this.config.apiKey) {\n      headers.Authorization = `Bearer ${this.config.apiKey}`;\n    }\n\n    const res = await fetch(`${url}/v1/skills?${params}`, { headers });\n    const body = (await res.json()) as { data: unknown[] };\n    return body.data;\n  }\n\n  /** Format a KnowledgeUnit as few-shot text for LLM prompt injection */\n  toFewShot(unit: KnowledgeUnit): string {\n    switch (unit[\"@type\"]) {\n      case \"ReasoningTrace\":\n        return formatReasoningTrace(unit);\n      case \"ToolCallPattern\":\n        return formatToolCallPattern(unit);\n      case \"ExpertSOP\":\n        return formatExpertSOP(unit);\n    }\n  }\n}\n\nfunction formatReasoningTrace(trace: ReasoningTrace): string {\n  return trace.steps\n    .map((s) => `[${s.type.toUpperCase()}] ${s.content ?? s.output_summary ?? \"\"}`)\n    .join(\"\\n\");\n}\n\nfunction formatToolCallPattern(pattern: ToolCallPattern): string {\n  const lines = [`Pattern: ${pattern.name}`, `Description: ${pattern.description}`, \"Steps:\"];\n  for (const seq of pattern.tool_sequence) {\n    lines.push(`  ${seq.step} (${seq.execution}):`);\n    for (const tool of seq.tools) {\n      lines.push(`    - ${tool.name}${tool.query_template ? `: ${tool.query_template}` : \"\"}`);\n    }\n  }\n  return lines.join(\"\\n\");\n}\n\nfunction formatExpertSOP(sop: ExpertSOP): string {\n  const lines = [`SOP: ${sop.name}`, `Domain: ${sop.domain}`, \"Decision Tree:\"];\n  for (const node of sop.decision_tree) {\n    lines.push(`  ${node.step}: ${node.instruction}`);\n  }\n  return lines.join(\"\\n\");\n}\n","export class KPError extends Error {\n  constructor(\n    message: string,\n    public readonly code: string,\n  ) {\n    super(message);\n    this.name = \"KPError\";\n  }\n}\n\nexport class ValidationError extends KPError {\n  constructor(\n    message: string,\n    public readonly issues: Array<{ path: string; message: string }> = [],\n  ) {\n    super(message, \"VALIDATION_ERROR\");\n    this.name = \"ValidationError\";\n  }\n}\n\nexport class SanitizationError extends KPError {\n  constructor(\n    message: string,\n    public readonly field?: string,\n  ) {\n    super(message, \"SANITIZATION_ERROR\");\n    this.name = \"SanitizationError\";\n  }\n}\n\nexport class AuthenticationError extends KPError {\n  constructor(message = \"Authentication required\") {\n    super(message, \"AUTHENTICATION_ERROR\");\n    this.name = \"AuthenticationError\";\n  }\n}\n\nexport class RateLimitError extends KPError {\n  constructor(public readonly retryAfter: number) {\n    super(`Rate limit exceeded. Retry after ${retryAfter}s`, \"RATE_LIMIT_ERROR\");\n    this.name = \"RateLimitError\";\n  }\n}\n\nexport class NotFoundError extends KPError {\n  constructor(resource: string, id: string) {\n    super(`${resource} not found: ${id}`, \"NOT_FOUND\");\n    this.name = \"NotFoundError\";\n  }\n}\n","export async function sha256(data: string): Promise<string> {\n  const encoded = new TextEncoder().encode(data);\n  const buffer = await crypto.subtle.digest(\"SHA-256\", encoded);\n  return Array.from(new Uint8Array(buffer))\n    .map((b) => b.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n}\n","import { ValidationError } from \"./errors.js\";\nimport type { KnowledgeUnit, Visibility } from \"./types/knowledge-unit.js\";\nimport { KnowledgeUnitSchema } from \"./types/zod-schemas.js\";\nimport { sha256 } from \"./utils/hash.js\";\n\nexport interface ContributeConfig {\n  registryUrl?: string;\n  apiKey?: string;\n}\n\nexport async function contributeKnowledge(\n  unit: KnowledgeUnit,\n  config: ContributeConfig = {},\n): Promise<{ id: string; quality_score: number }> {\n  // Validate via Zod\n  const parsed = KnowledgeUnitSchema.safeParse(unit);\n  if (!parsed.success) {\n    throw new ValidationError(\n      \"Invalid KnowledgeUnit\",\n      parsed.error.issues.map((i) => ({\n        path: i.path.join(\".\"),\n        message: i.message,\n      })),\n    );\n  }\n\n  // Idempotency key via SHA-256\n  const idempotencyKey = await sha256(JSON.stringify(unit));\n\n  const url = config.registryUrl ?? \"https://registry.knowledgepulse.dev\";\n  const headers: Record<string, string> = {\n    \"Content-Type\": \"application/json\",\n    \"Idempotency-Key\": idempotencyKey,\n  };\n  if (config.apiKey) {\n    headers.Authorization = `Bearer ${config.apiKey}`;\n  }\n\n  const res = await fetch(`${url}/v1/knowledge`, {\n    method: \"POST\",\n    headers,\n    body: JSON.stringify(unit),\n  });\n\n  if (!res.ok) {\n    const body = await res.text();\n    throw new KPContributeError(`Failed to contribute: ${res.status} ${body}`);\n  }\n\n  return (await res.json()) as { id: string; quality_score: number };\n}\n\nexport async function contributeSkill(\n  skillMdContent: string,\n  visibility: Visibility = \"network\",\n  config: ContributeConfig = {},\n): Promise<{ id: string }> {\n  const idempotencyKey = await sha256(skillMdContent);\n\n  const url = config.registryUrl ?? \"https://registry.knowledgepulse.dev\";\n  const headers: Record<string, string> = {\n    \"Content-Type\": \"application/json\",\n    \"Idempotency-Key\": idempotencyKey,\n  };\n  if (config.apiKey) {\n    headers.Authorization = `Bearer ${config.apiKey}`;\n  }\n\n  const res = await fetch(`${url}/v1/skills`, {\n    method: \"POST\",\n    headers,\n    body: JSON.stringify({ skill_md_content: skillMdContent, visibility }),\n  });\n\n  if (!res.ok) {\n    const body = await res.text();\n    throw new KPContributeError(`Failed to contribute skill: ${res.status} ${body}`);\n  }\n\n  return (await res.json()) as { id: string };\n}\n\nclass KPContributeError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = \"KPContributeError\";\n  }\n}\n","import { parse as parseYaml, stringify as stringifyYaml } from \"yaml\";\nimport { ValidationError } from \"./errors.js\";\nimport type { SkillMdFrontmatter, SkillMdKpExtension } from \"./types/knowledge-unit.js\";\nimport { SkillMdFrontmatterSchema, SkillMdKpExtensionSchema } from \"./types/zod-schemas.js\";\nimport { sanitizeSkillMd } from \"./utils/sanitizer.js\";\n\nexport interface ParsedSkillMd {\n  frontmatter: SkillMdFrontmatter;\n  kp?: SkillMdKpExtension;\n  body: string;\n  raw: string;\n}\n\nconst FRONTMATTER_RE = /^---\\n([\\s\\S]*?)\\n---\\n?([\\s\\S]*)$/;\n\nexport function parseSkillMd(content: string): ParsedSkillMd {\n  const match = content.match(FRONTMATTER_RE);\n  if (!match) {\n    throw new ValidationError(\"Invalid SKILL.md: missing YAML frontmatter delimiters (---)\");\n  }\n\n  const yamlStr = match[1]!;\n  const body = match[2]!;\n\n  let yamlData: Record<string, unknown>;\n  try {\n    yamlData = parseYaml(yamlStr) as Record<string, unknown>;\n  } catch (e) {\n    throw new ValidationError(\n      `Invalid SKILL.md: YAML parse error: ${e instanceof Error ? e.message : String(e)}`,\n    );\n  }\n\n  // Extract kp extension if present\n  const kpRaw = yamlData.kp as Record<string, unknown> | undefined;\n  const { kp: _, ...frontmatterRaw } = yamlData;\n\n  // Validate frontmatter\n  const fmResult = SkillMdFrontmatterSchema.safeParse(frontmatterRaw);\n  if (!fmResult.success) {\n    throw new ValidationError(\n      \"Invalid SKILL.md frontmatter\",\n      fmResult.error.issues.map((i) => ({\n        path: i.path.join(\".\"),\n        message: i.message,\n      })),\n    );\n  }\n\n  // Validate kp extension if present\n  let kp: SkillMdKpExtension | undefined;\n  if (kpRaw) {\n    const kpResult = SkillMdKpExtensionSchema.safeParse(kpRaw);\n    if (!kpResult.success) {\n      throw new ValidationError(\n        \"Invalid SKILL.md kp extension\",\n        kpResult.error.issues.map((i) => ({\n          path: `kp.${i.path.join(\".\")}`,\n          message: i.message,\n        })),\n      );\n    }\n    kp = kpResult.data;\n  }\n\n  return {\n    frontmatter: fmResult.data,\n    kp,\n    body,\n    raw: content,\n  };\n}\n\nexport function generateSkillMd(\n  frontmatter: SkillMdFrontmatter,\n  body: string,\n  kp?: SkillMdKpExtension,\n): string {\n  const yamlData: Record<string, unknown> = { ...frontmatter };\n  if (kp) {\n    yamlData.kp = kp;\n  }\n\n  return `---\\n${stringifyYaml(yamlData).trim()}\\n---\\n\\n${body}`;\n}\n\nexport function validateSkillMd(content: string): { valid: boolean; errors: string[] } {\n  const errors: string[] = [];\n\n  // Sanitize first\n  try {\n    const { warnings } = sanitizeSkillMd(content);\n    errors.push(...warnings.map((w) => `Warning: ${w}`));\n  } catch (e) {\n    return {\n      valid: false,\n      errors: [e instanceof Error ? e.message : String(e)],\n    };\n  }\n\n  // Then parse\n  try {\n    parseSkillMd(content);\n  } catch (e) {\n    if (e instanceof ValidationError) {\n      return {\n        valid: false,\n        errors: [e.message, ...e.issues.map((i) => `  ${i.path}: ${i.message}`)],\n      };\n    }\n    return {\n      valid: false,\n      errors: [e instanceof Error ? e.message : String(e)],\n    };\n  }\n\n  return { valid: true, errors };\n}\n","import { SanitizationError } from \"../errors.js\";\n\n// Invisible Unicode characters to reject (PRD Section 3.5.1 T-2)\nconst INVISIBLE_CHARS =\n  /[\\u200B-\\u200F\\u2028-\\u202F\\u2060-\\u2064\\u2066-\\u2069\\uFEFF\\uFFF9-\\uFFFB]/g;\n\n// HTML tag pattern\nconst HTML_TAG = /<\\/?[a-zA-Z][^>]*>/g;\n\n// HTML comment pattern\nconst HTML_COMMENT = /<!--[\\s\\S]*?-->/g;\n\n// Common prompt injection patterns\nconst INJECTION_PATTERNS = [\n  /ignore\\s+(all\\s+)?previous\\s+instructions/i,\n  /you\\s+are\\s+now\\s+/i,\n  /system\\s*:\\s*/i,\n  /\\[INST\\]/i,\n  /<\\|im_start\\|>/i,\n  /<<SYS>>/i,\n];\n\nexport interface SanitizeResult {\n  content: string;\n  warnings: string[];\n}\n\nexport function sanitizeSkillMd(content: string): SanitizeResult {\n  const warnings: string[] = [];\n  let sanitized = content;\n\n  // Strip HTML comments\n  if (HTML_COMMENT.test(sanitized)) {\n    warnings.push(\"Removed HTML comments\");\n    sanitized = sanitized.replace(HTML_COMMENT, \"\");\n  }\n\n  // Strip HTML tags\n  if (HTML_TAG.test(sanitized)) {\n    warnings.push(\"Removed HTML tags\");\n    sanitized = sanitized.replace(HTML_TAG, \"\");\n  }\n\n  // Reject invisible characters\n  if (INVISIBLE_CHARS.test(sanitized)) {\n    throw new SanitizationError(\n      \"Content contains invisible Unicode characters that may be used for steganography\",\n    );\n  }\n\n  // Normalize Unicode to NFC\n  sanitized = sanitized.normalize(\"NFC\");\n\n  // Check for prompt injection patterns\n  for (const pattern of INJECTION_PATTERNS) {\n    if (pattern.test(sanitized)) {\n      throw new SanitizationError(\n        `Content contains suspected prompt injection pattern: ${pattern.source}`,\n      );\n    }\n  }\n\n  return { content: sanitized, warnings };\n}\n","export type MigrationFn<TFrom = unknown, TTo = unknown> = (input: TFrom) => TTo;\n\nexport interface MigrationEntry {\n  from: string;\n  to: string;\n  migrate: MigrationFn;\n}\n\nexport class MigrationRegistry {\n  private migrations = new Map<string, MigrationEntry>();\n\n  register(entry: MigrationEntry): void {\n    const key = `${entry.from}->${entry.to}`;\n    this.migrations.set(key, entry);\n  }\n\n  get(from: string, to: string): MigrationEntry | undefined {\n    return this.migrations.get(`${from}->${to}`);\n  }\n\n  /** Build a migration chain from `from` to `to` */\n  chain(from: string, to: string): MigrationFn[] {\n    const fns: MigrationFn[] = [];\n    let current = from;\n\n    while (current !== to) {\n      // Try direct migration first\n      const direct = this.get(current, to);\n      if (direct) {\n        fns.push(direct.migrate);\n        return fns;\n      }\n\n      // Find next step in chain\n      let found = false;\n      for (const entry of this.migrations.values()) {\n        if (entry.from === current) {\n          fns.push(entry.migrate);\n          current = entry.to;\n          found = true;\n          break;\n        }\n      }\n\n      if (!found) {\n        throw new Error(`No migration path from ${current} to ${to}`);\n      }\n    }\n\n    return fns;\n  }\n}\n","import type { MigrationFn } from \"./types.js\";\n\n/**\n * Placeholder migration from v1 to v2.\n * Establishes the migration pattern for future schema evolution.\n */\nexport const migrateV1ToV2: MigrationFn = (input: unknown): unknown => {\n  // When v2 schema changes are defined, transform fields here.\n  // For now, pass through as-is.\n  return input;\n};\n","import { MigrationRegistry } from \"./types.js\";\nimport { migrateV1ToV2 } from \"./v1-to-v2.js\";\n\nconst registry = new MigrationRegistry();\n\n// Register known migrations\nregistry.register({ from: \"v1\", to: \"v2\", migrate: migrateV1ToV2 });\n\n/**\n * Migrate a KnowledgeUnit from one schema version to another.\n * Automatically chains intermediate migrations.\n */\nexport function migrate(unit: unknown, fromVersion: string, toVersion: string): unknown {\n  if (fromVersion === toVersion) return unit;\n\n  const chain = registry.chain(fromVersion, toVersion);\n  let result = unit;\n  for (const fn of chain) {\n    result = fn(result);\n  }\n  return result;\n}\n\nexport { MigrationRegistry } from \"./types.js\";\nexport type { MigrationFn, MigrationEntry } from \"./types.js\";\n","import type { EigenTrustConfig, EigenTrustResult, ValidationVote } from \"./types.js\";\n\nconst DEFAULT_CONFIG: EigenTrustConfig = {\n  alpha: 0.1,\n  epsilon: 0.001,\n  maxIterations: 50,\n  preTrustScore: 0.1,\n};\n\n/**\n * Compute EigenTrust reputation scores from validation votes.\n *\n * Algorithm:\n * 1. Collect unique agents from votes\n * 2. Build raw trust matrix: positive vote = +1, negative vote = -0.5, ignore self-votes\n * 3. Clamp negatives to 0, row-normalize\n * 4. Pre-trust vector p = uniform(1/n)\n * 5. Iterate: T(i+1) = (1-alpha) * C^T * T(i) + alpha * p\n * 6. Converge when max(|T(i+1) - T(i)|) < epsilon\n */\nexport function computeEigenTrust(\n  votes: ValidationVote[],\n  configOverrides?: Partial<EigenTrustConfig>,\n): EigenTrustResult {\n  const config: EigenTrustConfig = { ...DEFAULT_CONFIG, ...configOverrides };\n  const { alpha, epsilon, maxIterations } = config;\n\n  // Empty votes → empty result\n  if (votes.length === 0) {\n    return { scores: new Map(), iterations: 0, converged: true };\n  }\n\n  // Step 1: Collect unique agents\n  const agentSet = new Set<string>();\n  for (const vote of votes) {\n    agentSet.add(vote.validatorId);\n    agentSet.add(vote.targetId);\n  }\n  const agents = Array.from(agentSet);\n  const n = agents.length;\n  const agentIndex = new Map<string, number>();\n  for (let i = 0; i < n; i++) {\n    agentIndex.set(agents[i] as string, i);\n  }\n\n  // Step 2: Build raw trust matrix\n  // rawTrust[i][j] = aggregated trust from agent i toward agent j\n  const rawTrust: number[][] = Array.from({ length: n }, () =>\n    new Array<number>(n).fill(0),\n  );\n\n  for (const vote of votes) {\n    const from = agentIndex.get(vote.validatorId)!;\n    const to = agentIndex.get(vote.targetId)!;\n\n    // Ignore self-votes\n    if (from === to) continue;\n\n    const row = rawTrust[from] as number[];\n    row[to] = (row[to] as number) + (vote.valid ? 1 : -0.5);\n  }\n\n  // Step 3: Clamp negatives to 0 and row-normalize\n  const C: number[][] = Array.from({ length: n }, () =>\n    new Array<number>(n).fill(0),\n  );\n\n  for (let i = 0; i < n; i++) {\n    const rawRow = rawTrust[i] as number[];\n    const cRow = C[i] as number[];\n\n    // Clamp negatives\n    for (let j = 0; j < n; j++) {\n      rawRow[j] = Math.max(0, rawRow[j] as number);\n    }\n\n    // Row sum\n    let rowSum = 0;\n    for (let j = 0; j < n; j++) {\n      rowSum += rawRow[j] as number;\n    }\n\n    // Normalize row (if rowSum > 0)\n    if (rowSum > 0) {\n      for (let j = 0; j < n; j++) {\n        cRow[j] = (rawRow[j] as number) / rowSum;\n      }\n    } else {\n      // If an agent has no outgoing trust, distribute uniformly\n      for (let j = 0; j < n; j++) {\n        cRow[j] = 1 / n;\n      }\n    }\n  }\n\n  // Step 4: Pre-trust vector p = uniform(1/n)\n  const p = new Array<number>(n).fill(1 / n);\n\n  // Step 5: Iterate T(i+1) = (1-alpha) * C^T * T(i) + alpha * p\n  // Initialize t from local trust (column sums of raw trust matrix after clamping)\n  // This gives agents who received more positive votes a head start,\n  // which is critical for sybil resistance and convergence behavior.\n  const localTrust = new Array<number>(n).fill(0);\n  let localSum = 0;\n  for (let j = 0; j < n; j++) {\n    for (let i = 0; i < n; i++) {\n      const rawRow = rawTrust[i] as number[];\n      localTrust[j] = (localTrust[j] as number) + (rawRow[j] as number);\n    }\n    localSum += localTrust[j] as number;\n  }\n  let t: number[];\n  if (localSum > 0) {\n    t = localTrust.map((v: number) => v / localSum);\n  } else {\n    t = new Array<number>(n).fill(1 / n);\n  }\n  let iterations = 0;\n  let converged = false;\n\n  for (let iter = 0; iter < maxIterations; iter++) {\n    iterations = iter + 1;\n\n    // Compute C^T * t\n    const ct = new Array<number>(n).fill(0);\n    for (let j = 0; j < n; j++) {\n      for (let i = 0; i < n; i++) {\n        const cRow = C[i] as number[];\n        ct[j] = (ct[j] as number) + (cRow[j] as number) * (t[i] as number);\n      }\n    }\n\n    // T(i+1) = (1-alpha) * C^T * T(i) + alpha * p\n    const tNext = new Array<number>(n);\n    for (let j = 0; j < n; j++) {\n      tNext[j] =\n        (1 - alpha) * (ct[j] as number) + alpha * (p[j] as number);\n    }\n\n    // Check convergence: max(|T(i+1) - T(i)|) < epsilon\n    let maxDiff = 0;\n    for (let j = 0; j < n; j++) {\n      maxDiff = Math.max(\n        maxDiff,\n        Math.abs((tNext[j] as number) - (t[j] as number)),\n      );\n    }\n\n    t = tNext;\n\n    if (maxDiff < epsilon) {\n      converged = true;\n      break;\n    }\n  }\n\n  // Build result map\n  const scores = new Map<string, number>();\n  for (let i = 0; i < n; i++) {\n    scores.set(agents[i] as string, t[i] as number);\n  }\n\n  return { scores, iterations, converged };\n}\n","/**\n * W3C Verifiable Credential signing with Ed25519 for KP-REP reputation system.\n *\n * Implements:\n * - Ed25519 key pair generation\n * - W3C VC creation (unsigned)\n * - Ed25519Signature2020 signing\n * - Signature verification\n */\nimport * as ed25519 from \"@noble/ed25519\";\nimport { sha512 } from \"@noble/hashes/sha2.js\";\nimport type { ReputationCredential } from \"./types.js\";\n\n// Configure @noble/ed25519 sync sha512 from @noble/hashes\ned25519.hashes.sha512 = (msg: Uint8Array): Uint8Array =>\n  sha512(msg);\n\nexport interface KeyPair {\n  publicKey: Uint8Array;\n  privateKey: Uint8Array;\n}\n\n/**\n * Generate an Ed25519 key pair for credential signing.\n */\nexport async function generateKeyPair(): Promise<KeyPair> {\n  const privateKey = ed25519.utils.randomSecretKey();\n  const publicKey = await ed25519.getPublicKeyAsync(privateKey);\n  return { publicKey, privateKey };\n}\n\n/**\n * Create an unsigned W3C Verifiable Credential for a reputation score.\n */\nexport function createCredential(opts: {\n  issuer: string;\n  agentId: string;\n  score: number;\n  contributions: number;\n  validations: number;\n  domain?: string;\n}): ReputationCredential {\n  const credential: ReputationCredential = {\n    \"@context\": [\n      \"https://www.w3.org/2018/credentials/v1\",\n      \"https://knowledgepulse.dev/credentials/v1\",\n    ],\n    type: [\"VerifiableCredential\", \"KPReputationCredential\"],\n    issuer: opts.issuer,\n    issuanceDate: new Date().toISOString(),\n    credentialSubject: {\n      id: opts.agentId,\n      score: opts.score,\n      contributions: opts.contributions,\n      validations: opts.validations,\n    },\n  };\n\n  if (opts.domain !== undefined) {\n    credential.credentialSubject.domain = opts.domain;\n  }\n\n  return credential;\n}\n\n/**\n * Produce a canonical JSON form of the credential (excluding the proof field)\n * for signing and verification.\n */\nfunction canonicalize(vc: ReputationCredential): string {\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  const { proof, ...rest } = vc;\n  return JSON.stringify(rest);\n}\n\n/**\n * Sign a W3C Verifiable Credential with an Ed25519 private key.\n * Returns a new credential object with the proof attached.\n */\nexport async function signCredential(\n  vc: ReputationCredential,\n  privateKey: Uint8Array,\n  verificationMethod: string,\n): Promise<ReputationCredential> {\n  const canonical = canonicalize(vc);\n  const message = new TextEncoder().encode(canonical);\n  const signature = await ed25519.signAsync(message, privateKey);\n\n  // Base64-encode the signature\n  const proofValue = bytesToBase64(signature);\n\n  return {\n    ...vc,\n    proof: {\n      type: \"Ed25519Signature2020\",\n      created: new Date().toISOString(),\n      verificationMethod,\n      proofPurpose: \"assertionMethod\",\n      proofValue,\n    },\n  };\n}\n\n/**\n * Verify an Ed25519-signed W3C Verifiable Credential.\n * Returns true if the signature is valid, false otherwise.\n */\nexport async function verifyCredential(\n  vc: ReputationCredential,\n  publicKey: Uint8Array,\n): Promise<boolean> {\n  if (!vc.proof) {\n    return false;\n  }\n\n  const canonical = canonicalize(vc);\n  const message = new TextEncoder().encode(canonical);\n  const signature = base64ToBytes(vc.proof.proofValue);\n\n  try {\n    return await ed25519.verifyAsync(signature, message, publicKey);\n  } catch {\n    return false;\n  }\n}\n\n// --- Base64 helpers ---\n\nfunction bytesToBase64(bytes: Uint8Array): string {\n  let binary = \"\";\n  for (let i = 0; i < bytes.length; i++) {\n    binary += String.fromCharCode(bytes[i] as number);\n  }\n  return btoa(binary);\n}\n\nfunction base64ToBytes(base64: string): Uint8Array {\n  const binary = atob(base64);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return bytes;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACKO,IAAM,aAAa;;;ACL1B,iBAAkB;AAKX,IAAM,0BAA0B,aAAE,KAAK,CAAC,kBAAkB,mBAAmB,WAAW,CAAC;AAEzF,IAAM,qBAAqB,aAAE,KAAK,CAAC,cAAc,aAAa,SAAS,CAAC;AACxE,IAAM,mBAAmB,aAAE,KAAK,CAAC,WAAW,OAAO,SAAS,CAAC;AAI7D,IAAM,0BAA0B,aAAE,OAAO;AAAA,EAC9C,YAAY,aAAE,OAAO,EAAE,SAAS;AAAA,EAChC,UAAU,aAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,WAAW,aAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,aAAa,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EAC7B,SAAS,aAAE,QAAQ;AAAA,EACnB,eAAe,aAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC;AAAA,EACtC,YAAY;AAAA,EACZ,eAAe;AAAA,EACf,cAAc,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,SAAS;AAC7C,CAAC;AAIM,IAAM,2BAA2B,aAAE,OAAO;AAAA,EAC/C,SAAS,aAAE,OAAO,EAAE,IAAI,EAAE,YAAY;AAAA,EACtC,MAAM,aAAE,KAAK,CAAC,WAAW,aAAa,eAAe,gBAAgB,CAAC;AAAA,EACtE,SAAS,aAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,MAAM,aACH,OAAO;AAAA,IACN,MAAM,aAAE,OAAO;AAAA,IACf,YAAY,aAAE,OAAO,EAAE,SAAS;AAAA,EAClC,CAAC,EACA,SAAS;AAAA,EACZ,OAAO,aAAE,OAAO,aAAE,QAAQ,CAAC,EAAE,SAAS;AAAA,EACtC,gBAAgB,aAAE,OAAO,EAAE,SAAS;AAAA,EACpC,YAAY,aAAE,OAAO,EAAE,YAAY,EAAE,SAAS;AAChD,CAAC;AAEM,IAAM,uBAAuB,aAAE,OAAO;AAAA,EAC3C,YAAY,aAAE,QAAQ,UAAU;AAAA,EAChC,SAAS,aAAE,QAAQ,gBAAgB;AAAA,EACnC,IAAI,aAAE,OAAO,EAAE,WAAW,WAAW;AAAA,EACrC,cAAc,aAAE,OAAO,EAAE,SAAS;AAAA,EAClC,UAAU;AAAA,EACV,MAAM,aAAE,OAAO;AAAA,IACb,WAAW,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IAC3B,cAAc,aAAE,OAAO,aAAE,QAAQ,CAAC,EAAE,SAAS;AAAA,EAC/C,CAAC;AAAA,EACD,OAAO,aAAE,MAAM,wBAAwB,EAAE,IAAI,CAAC;AAAA,EAC9C,SAAS,aAAE,OAAO;AAAA,IAChB,gBAAgB,aAAE,OAAO;AAAA,IACzB,YAAY,aAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC;AAAA,EACrC,CAAC;AAAA,EACD,uBAAuB,aACpB,OAAO;AAAA,IACN,UAAU,aAAE,MAAM,aAAE,OAAO,EAAE,MAAM,aAAE,OAAO,GAAG,MAAM,aAAE,OAAO,EAAE,CAAC,CAAC;AAAA,IAClE,eAAe,aAAE,MAAM,aAAE,OAAO,EAAE,MAAM,aAAE,OAAO,GAAG,YAAY,aAAE,OAAO,EAAE,CAAC,CAAC;AAAA,EAC/E,CAAC,EACA,SAAS;AACd,CAAC;AAIM,IAAM,wBAAwB,aAAE,OAAO;AAAA,EAC5C,YAAY,aAAE,QAAQ,UAAU;AAAA,EAChC,SAAS,aAAE,QAAQ,iBAAiB;AAAA,EACpC,IAAI,aAAE,OAAO,EAAE,WAAW,aAAa;AAAA,EACvC,MAAM,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACtB,aAAa,aAAE,OAAO;AAAA,EACtB,UAAU;AAAA,EACV,oBAAoB,aAAE,OAAO;AAAA,IAC3B,YAAY,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,IAAI,CAAC;AAAA,IACrC,gBAAgB,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,SAAS;AAAA,EAC/C,CAAC;AAAA,EACD,eAAe,aACZ;AAAA,IACC,aAAE,OAAO;AAAA,MACP,MAAM,aAAE,OAAO;AAAA,MACf,WAAW,aAAE,KAAK,CAAC,YAAY,YAAY,CAAC;AAAA,MAC5C,OAAO,aAAE;AAAA,QACP,aAAE,OAAO;AAAA,UACP,MAAM,aAAE,OAAO;AAAA,UACf,gBAAgB,aAAE,OAAO,EAAE,SAAS;AAAA,UACpC,gBAAgB,aAAE,OAAO,aAAE,QAAQ,CAAC,EAAE,SAAS;AAAA,QACjD,CAAC;AAAA,MACH;AAAA,MACA,WAAW,aAAE,OAAO,EAAE,SAAS;AAAA,IACjC,CAAC;AAAA,EACH,EACC,IAAI,CAAC;AAAA,EACR,aAAa,aAAE,OAAO;AAAA,IACpB,QAAQ,aAAE,OAAO,EAAE,YAAY;AAAA,IAC/B,cAAc,aAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC;AAAA,IACrC,MAAM,aAAE,OAAO,EAAE,IAAI,EAAE,YAAY;AAAA,EACrC,CAAC;AACH,CAAC;AAIM,IAAM,kBAAkB,aAAE,OAAO;AAAA,EACtC,YAAY,aAAE,QAAQ,UAAU;AAAA,EAChC,SAAS,aAAE,QAAQ,WAAW;AAAA,EAC9B,IAAI,aAAE,OAAO,EAAE,WAAW,SAAS;AAAA,EACnC,MAAM,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACtB,QAAQ,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACxB,UAAU;AAAA,EACV,QAAQ,aAAE,OAAO;AAAA,IACf,MAAM,aAAE,QAAQ,cAAc;AAAA,IAC9B,WAAW,aAAE,OAAO;AAAA,IACpB,aAAa,aAAE,MAAM,aAAE,OAAO,CAAC;AAAA,EACjC,CAAC;AAAA,EACD,eAAe,aACZ;AAAA,IACC,aAAE,OAAO;AAAA,MACP,MAAM,aAAE,OAAO;AAAA,MACf,aAAa,aAAE,OAAO;AAAA,MACtB,UAAU,aAAE,OAAO,aAAE,OAAO,CAAC,EAAE,SAAS;AAAA,MACxC,YAAY,aACT;AAAA,QACC,aAAE,OAAO;AAAA,UACP,QAAQ,aAAE,OAAO;AAAA,UACjB,SAAS,aAAE,OAAO,EAAE,SAAS;AAAA,QAC/B,CAAC;AAAA,MACH,EACC,SAAS;AAAA,MACZ,kBAAkB,aAAE,MAAM,aAAE,OAAO,EAAE,MAAM,aAAE,OAAO,GAAG,MAAM,aAAE,OAAO,EAAE,CAAC,CAAC,EAAE,SAAS;AAAA,IACvF,CAAC;AAAA,EACH,EACC,IAAI,CAAC;AAAA,EACR,YAAY,aACT,OAAO;AAAA,IACN,YAAY,aAAE;AAAA,MACZ,aAAE,OAAO;AAAA,QACP,OAAO,aAAE,OAAO,aAAE,QAAQ,CAAC;AAAA,QAC3B,iBAAiB,aAAE,OAAO,aAAE,QAAQ,CAAC;AAAA,MACvC,CAAC;AAAA,IACH;AAAA,EACF,CAAC,EACA,SAAS;AACd,CAAC;AAIM,IAAM,sBAAsB,aAAE,mBAAmB,SAAS;AAAA,EAC/D;AAAA,EACA;AAAA,EACA;AACF,CAAC;AAIM,IAAM,2BAA2B,aAAE,OAAO;AAAA,EAC/C,MAAM,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACtB,aAAa,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EAC7B,SAAS,aAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,QAAQ,aAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,SAAS,aAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,MAAM,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,SAAS;AAAA,EACnC,iBAAiB,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,SAAS;AAChD,CAAC;AAEM,IAAM,2BAA2B,aAAE,OAAO;AAAA,EAC/C,mBAAmB,aAAE,QAAQ,EAAE,SAAS;AAAA,EACxC,QAAQ,aAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,mBAAmB,aAAE,OAAO,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EACrD,eAAe,mBAAmB,SAAS;AAAA,EAC3C,YAAY,iBAAiB,SAAS;AAAA,EACtC,iBAAiB,aAAE,QAAQ,EAAE,SAAS;AACxC,CAAC;;;AChKM,IAAM,cAAN,MAAkB;AAAA,EACf,UAAwB,CAAC;AAAA,EAChB;AAAA,EACA;AAAA,EACA;AAAA,EAEjB,YAAY,OAAsE,CAAC,GAAG;AACpF,SAAK,cAAc,KAAK,eAAe;AACvC,SAAK,aAAa,KAAK,cAAc;AACrC,SAAK,QAAQ,KAAK,SAAS;AAAA,EAC7B;AAAA,EAEA,IAAI,OAAe;AACjB,SAAK,aAAa;AAClB,WAAO,KAAK,QAAQ;AAAA,EACtB;AAAA,EAEA,IAAI,QAAiC;AACnC,QAAI,OAAO,WAAW,KAAK,YAAY;AACrC,YAAM,IAAI,MAAM,YAAY,KAAK,UAAU,oBAAoB,OAAO,MAAM,EAAE;AAAA,IAChF;AACA,UAAM,IAAI,kBAAkB,eAAe,SAAS,IAAI,aAAa,MAAM;AAC3E,SAAK,QAAQ,KAAK,EAAE,QAAQ,GAAG,SAAS,KAAK,IAAI,EAAE,CAAC;AAGpD,QAAI,KAAK,QAAQ,SAAS,KAAK,aAAa;AAC1C,WAAK,QAAQ,MAAM;AAAA,IACrB;AAAA,EACF;AAAA;AAAA,EAGA,eAAqB;AACnB,QAAI,KAAK,UAAU,KAAM;AACzB,UAAM,MAAM,KAAK,IAAI;AACrB,UAAM,SAAS,MAAM,KAAK;AAC1B,SAAK,UAAU,KAAK,QAAQ,OAAO,CAAC,MAAM,EAAE,UAAU,MAAM;AAAA,EAC9D;AAAA,EAEA,oBAAoB,OAAkC;AACpD,SAAK,aAAa;AAClB,QAAI,KAAK,QAAQ,WAAW,EAAG,QAAO;AAEtC,UAAM,IAAI,iBAAiB,eAAe,QAAQ,IAAI,aAAa,KAAK;AACxE,QAAI,SAAS;AAEb,eAAW,SAAS,KAAK,SAAS;AAChC,YAAM,MAAM,iBAAiB,GAAG,MAAM,MAAM;AAC5C,UAAI,MAAM,OAAQ,UAAS;AAAA,IAC7B;AAEA,WAAO;AAAA,EACT;AAAA,EAEA,QAAc;AACZ,SAAK,UAAU,CAAC;AAAA,EAClB;AACF;AAEA,SAAS,iBAAiB,GAAiB,GAAyB;AAClE,MAAI,MAAM;AACV,MAAI,QAAQ;AACZ,MAAI,QAAQ;AAEZ,WAAS,IAAI,GAAG,IAAI,EAAE,QAAQ,KAAK;AACjC,WAAO,EAAE,CAAC,IAAK,EAAE,CAAC;AAClB,aAAS,EAAE,CAAC,IAAK,EAAE,CAAC;AACpB,aAAS,EAAE,CAAC,IAAK,EAAE,CAAC;AAAA,EACtB;AAEA,QAAM,QAAQ,KAAK,KAAK,KAAK,IAAI,KAAK,KAAK,KAAK;AAChD,SAAO,UAAU,IAAI,IAAI,MAAM;AACjC;;;ACxEA,IAAM,kBAAkC;AAAA,EACtC,YAAY;AAAA,EACZ,SAAS;AAAA,EACT,eAAe;AAAA,EACf,mBAAmB;AACrB;AAEA,IAAM,iBAAiD;AAAA,EACrD,SAAS,EAAE,YAAY,KAAM,SAAS,MAAM,eAAe,KAAM,mBAAmB,KAAK;AAAA,EACzF,MAAM,EAAE,YAAY,KAAM,SAAS,KAAM,eAAe,KAAM,mBAAmB,IAAK;AAAA,EACtF,SAAS,EAAE,YAAY,MAAM,SAAS,KAAM,eAAe,KAAM,mBAAmB,KAAK;AAAA,EACzF,kBAAkB,EAAE,YAAY,KAAM,SAAS,KAAM,eAAe,KAAM,mBAAmB,IAAK;AACpG;AAEA,SAAS,WAAW,QAAgC;AAClD,SAAO,eAAe,MAAM,KAAK;AACnC;AAEA,IAAM,aAAa,IAAI,YAAY,EAAE,aAAa,KAAM,YAAY,IAAI,CAAC;AAGzE,IAAI,kBAAoF;AAExF,eAAe,cAAyE;AACtF,MAAI,gBAAiB,QAAO;AAE5B,qBAAmB,YAAY;AAC7B,QAAI;AACF,YAAM,EAAE,SAAS,IAAI,MAAM,OAAO,2BAA2B;AAC7D,YAAM,OAAO,MAAM,SAAS,sBAAsB,yBAAyB;AAC3E,aAAO,OAAO,SAAwC;AACpD,cAAM,SAAS,MAAM,KAAK,MAAM,EAAE,SAAS,QAAQ,WAAW,KAAK,CAAC;AACpE,eAAO,IAAI,aAAa,OAAO,IAAyB;AAAA,MAC1D;AAAA,IACF,QAAQ;AAEN,aAAO;AAAA,IACT;AAAA,EACF,GAAG;AAEH,SAAO;AACT;AAEA,eAAsB,cAAc,OAAwC;AAC1E,QAAM,EAAE,OAAO,SAAS,KAAK,IAAI;AAGjC,QAAM,cAAc,IAAI,IAAI,MAAM,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,EAAE;AACtD,QAAM,gBAAgB,MAAM,OAAO,CAAC,MAAM,EAAE,SAAS,gBAAgB,EAAE;AACvE,QAAM,IAAI,KAAK;AAAA,IACb;AAAA,IACC,cAAc,IAAK,OAAO,gBAAgB,IAAI,MAAM,KAAM,MAAM,SAAS,KAAM;AAAA,EAClF;AAGA,MAAI,IAAI;AACR,QAAM,WAAW,MAAM,YAAY;AACnC,MAAI,UAAU;AACZ,UAAM,OAAO,GAAG,KAAK,SAAS,IAAI,MAAM,IAAI,CAAC,MAAM,EAAE,WAAW,EAAE,EAAE,KAAK,GAAG,CAAC;AAC7E,UAAM,YAAY,MAAM,SAAS,IAAI;AACrC,QAAI,WAAW,OAAO,IAAI,IAAM,WAAW,oBAAoB,SAAS,IAAI;AAE5E,eAAW,IAAI,SAAS;AAAA,EAC1B;AAGA,QAAM,cAAc,IAAI,IAAI,MAAM,OAAO,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,CAAC,MAAM,EAAE,MAAM,IAAI,CAAC,EAAE;AAClF,QAAM,IAAI,KAAK,IAAI,GAAM,cAAc,KAAK,IAAI,GAAG,MAAM,MAAM,IAAK,CAAC;AAGrE,QAAM,IAAI,QAAQ,cAAc,MAAM,SAAS,UAAU,IAAM;AAG/D,QAAM,IAAI,WAAW,MAAM,SAAS,WAAW;AAC/C,MAAI,QAAQ,IAAI,EAAE,aAAa,IAAI,EAAE,UAAU,IAAI,EAAE,gBAAgB,IAAI,EAAE;AAG3E,MAAI,MAAM,WAAW,KAAK,MAAM,CAAC,GAAG,SAAS,UAAW,SAAQ;AAChE,MAAI,gBAAgB,KAAK,MAAM,SAAS,QAAS,SAAQ,KAAK,IAAI,GAAK,QAAQ,GAAG;AAClF,MAAI,eAAe,KAAK,MAAM,KAAK,CAAC,MAAM,EAAE,IAAI,EAAG,SAAQ,KAAK,IAAI,GAAK,QAAQ,GAAG;AAEpF,SAAO;AACT;;;AC5FA,SAAS,OAAe;AACtB,SAAO,OAAO,WAAW;AAC3B;AAEO,SAAS,kBAA0B;AACxC,SAAO,YAAY,KAAK,CAAC;AAC3B;AAEO,SAAS,oBAA4B;AAC1C,SAAO,cAAc,KAAK,CAAC;AAC7B;AAEO,SAAS,gBAAwB;AACtC,SAAO,UAAU,KAAK,CAAC;AACzB;AAEO,SAAS,kBAA0B;AACxC,SAAO,YAAY,KAAK,CAAC;AAC3B;;;ACEO,IAAM,YAAN,MAAgB;AAAA,EACb;AAAA,EAKR,YAAY,QAAuB;AACjC,SAAK,SAAS;AAAA,MACZ,aAAa;AAAA,MACb,gBAAgB;AAAA,MAChB,cAAc;AAAA,MACd,YAAY;AAAA,MACZ,GAAG;AAAA,IACL;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,KAAyD,SAAe;AACtE,YAAQ,UAAU,SAAoB;AACpC,UAAI,CAAC,KAAK,OAAO,aAAa;AAC5B,eAAO,QAAQ,GAAG,IAAI;AAAA,MACxB;AAEA,YAAM,UAAU,gBAAgB;AAChC,YAAM,YAAY,KAAK,IAAI;AAC3B,YAAM,QAA8B,CAAC;AAGrC,YAAM,KAAK;AAAA,QACT,SAAS;AAAA,QACT,MAAM;AAAA,QACN,SAAS,wBAAwB,KAAK,UAAU,IAAI,EAAE,MAAM,GAAG,GAAG,CAAC;AAAA,MACrE,CAAC;AAED,UAAI,UAAU;AACd,UAAI;AACJ,UAAI;AACF,iBAAS,MAAM,QAAQ,GAAG,IAAI;AAC9B,cAAM,KAAK;AAAA,UACT,SAAS,MAAM;AAAA,UACf,MAAM;AAAA,UACN,SAAS;AAAA,UACT,YAAY,KAAK,IAAI,IAAI;AAAA,QAC3B,CAAC;AAAA,MACH,SAAS,OAAO;AACd,kBAAU;AACV,cAAM,KAAK;AAAA,UACT,SAAS,MAAM;AAAA,UACf,MAAM;AAAA,UACN,SAAS,UAAU,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK,CAAC;AAAA,UACzE,YAAY,KAAK,IAAI,IAAI;AAAA,QAC3B,CAAC;AACD,cAAM;AAAA,MACR,UAAE;AAEA,cAAM,QAAwB;AAAA,UAC5B,YAAY;AAAA,UACZ,SAAS;AAAA,UACT,IAAI;AAAA,UACJ,UAAU;AAAA,YACR,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,YACnC,aAAa,KAAK,OAAO;AAAA,YACzB;AAAA,YACA,eAAe;AAAA;AAAA,YACf,YAAY,KAAK,OAAO;AAAA,YACxB,eAAe,KAAK,OAAO;AAAA,UAC7B;AAAA,UACA,MAAM;AAAA,YACJ,WAAW,sBAAsB,KAAK,OAAO,MAAM;AAAA,UACrD;AAAA,UACA;AAAA,UACA,SAAS;AAAA,YACP,gBAAgB,UAAU,cAAc;AAAA,YACxC,YAAY,UAAU,MAAM;AAAA,UAC9B;AAAA,QACF;AAGA,aAAK,KAAK,mBAAmB,KAAK,EAAE,MAAM,MAAM;AAAA,QAEhD,CAAC;AAAA,MACH;AAEA,aAAO;AAAA,IACT;AAAA,EACF;AAAA,EAEA,MAAc,mBAAmB,OAAsC;AACrE,UAAM,QAAQ,MAAM,cAAc,KAAK;AACvC,UAAM,SAAS,gBAAgB;AAE/B,QAAI,QAAQ,KAAK,OAAO,eAAgB;AAExC,UAAM,MAAM,KAAK,OAAO,eAAe;AACvC,UAAM,UAAkC;AAAA,MACtC,gBAAgB;AAAA,IAClB;AACA,QAAI,KAAK,OAAO,QAAQ;AACtB,cAAQ,gBAAgB,UAAU,KAAK,OAAO,MAAM;AAAA,IACtD;AAEA,UAAM,MAAM,GAAG,GAAG,iBAAiB;AAAA,MACjC,QAAQ;AAAA,MACR;AAAA,MACA,MAAM,KAAK,UAAU,KAAK;AAAA,IAC5B,CAAC;AAAA,EACH;AACF;;;AClHO,IAAM,cAAN,MAAkB;AAAA,EACf;AAAA,EAER,YAAY,SAA0B,CAAC,GAAG;AACxC,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,MAAM,OAAO,OAAe,QAA2C;AACrE,UAAM,SAAS,IAAI,gBAAgB;AAAA,MACjC,GAAG;AAAA,MACH,aAAa,OAAO,KAAK,OAAO,cAAc,GAAG;AAAA,MACjD,OAAO,OAAO,KAAK,OAAO,SAAS,CAAC;AAAA,IACtC,CAAC;AACD,QAAI,OAAQ,QAAO,IAAI,UAAU,MAAM;AACvC,QAAI,KAAK,OAAO,gBAAgB;AAC9B,aAAO,IAAI,SAAS,KAAK,OAAO,eAAe,KAAK,GAAG,CAAC;AAAA,IAC1D;AAEA,UAAM,MAAM,KAAK,OAAO,eAAe;AACvC,UAAM,UAAkC,CAAC;AACzC,QAAI,KAAK,OAAO,QAAQ;AACtB,cAAQ,gBAAgB,UAAU,KAAK,OAAO,MAAM;AAAA,IACtD;AAEA,UAAM,MAAM,MAAM,MAAM,GAAG,GAAG,iBAAiB,MAAM,IAAI,EAAE,QAAQ,CAAC;AACpE,UAAM,OAAQ,MAAM,IAAI,KAAK;AAC7B,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,MAAM,aACJ,OACA,MACoB;AACpB,UAAM,SAAS,IAAI,gBAAgB;AAAA,MACjC,GAAG;AAAA,MACH,OAAO,OAAO,MAAM,SAAS,KAAK,OAAO,SAAS,CAAC;AAAA,IACrD,CAAC;AACD,QAAI,MAAM,OAAQ,QAAO,IAAI,UAAU,KAAK,MAAM;AAClD,QAAI,MAAM,MAAM,OAAQ,QAAO,IAAI,QAAQ,KAAK,KAAK,KAAK,GAAG,CAAC;AAE9D,UAAM,MAAM,KAAK,OAAO,eAAe;AACvC,UAAM,UAAkC,CAAC;AACzC,QAAI,KAAK,OAAO,QAAQ;AACtB,cAAQ,gBAAgB,UAAU,KAAK,OAAO,MAAM;AAAA,IACtD;AAEA,UAAM,MAAM,MAAM,MAAM,GAAG,GAAG,cAAc,MAAM,IAAI,EAAE,QAAQ,CAAC;AACjE,UAAM,OAAQ,MAAM,IAAI,KAAK;AAC7B,WAAO,KAAK;AAAA,EACd;AAAA;AAAA,EAGA,UAAU,MAA6B;AACrC,YAAQ,KAAK,OAAO,GAAG;AAAA,MACrB,KAAK;AACH,eAAO,qBAAqB,IAAI;AAAA,MAClC,KAAK;AACH,eAAO,sBAAsB,IAAI;AAAA,MACnC,KAAK;AACH,eAAO,gBAAgB,IAAI;AAAA,IAC/B;AAAA,EACF;AACF;AAEA,SAAS,qBAAqB,OAA+B;AAC3D,SAAO,MAAM,MACV,IAAI,CAAC,MAAM,IAAI,EAAE,KAAK,YAAY,CAAC,KAAK,EAAE,WAAW,EAAE,kBAAkB,EAAE,EAAE,EAC7E,KAAK,IAAI;AACd;AAEA,SAAS,sBAAsB,SAAkC;AAC/D,QAAM,QAAQ,CAAC,YAAY,QAAQ,IAAI,IAAI,gBAAgB,QAAQ,WAAW,IAAI,QAAQ;AAC1F,aAAW,OAAO,QAAQ,eAAe;AACvC,UAAM,KAAK,KAAK,IAAI,IAAI,KAAK,IAAI,SAAS,IAAI;AAC9C,eAAW,QAAQ,IAAI,OAAO;AAC5B,YAAM,KAAK,SAAS,KAAK,IAAI,GAAG,KAAK,iBAAiB,KAAK,KAAK,cAAc,KAAK,EAAE,EAAE;AAAA,IACzF;AAAA,EACF;AACA,SAAO,MAAM,KAAK,IAAI;AACxB;AAEA,SAAS,gBAAgB,KAAwB;AAC/C,QAAM,QAAQ,CAAC,QAAQ,IAAI,IAAI,IAAI,WAAW,IAAI,MAAM,IAAI,gBAAgB;AAC5E,aAAW,QAAQ,IAAI,eAAe;AACpC,UAAM,KAAK,KAAK,KAAK,IAAI,KAAK,KAAK,WAAW,EAAE;AAAA,EAClD;AACA,SAAO,MAAM,KAAK,IAAI;AACxB;;;ACvGO,IAAM,UAAN,cAAsB,MAAM;AAAA,EACjC,YACE,SACgB,MAChB;AACA,UAAM,OAAO;AAFG;AAGhB,SAAK,OAAO;AAAA,EACd;AACF;AAEO,IAAM,kBAAN,cAA8B,QAAQ;AAAA,EAC3C,YACE,SACgB,SAAmD,CAAC,GACpE;AACA,UAAM,SAAS,kBAAkB;AAFjB;AAGhB,SAAK,OAAO;AAAA,EACd;AACF;AAEO,IAAM,oBAAN,cAAgC,QAAQ;AAAA,EAC7C,YACE,SACgB,OAChB;AACA,UAAM,SAAS,oBAAoB;AAFnB;AAGhB,SAAK,OAAO;AAAA,EACd;AACF;AAEO,IAAM,sBAAN,cAAkC,QAAQ;AAAA,EAC/C,YAAY,UAAU,2BAA2B;AAC/C,UAAM,SAAS,sBAAsB;AACrC,SAAK,OAAO;AAAA,EACd;AACF;AAEO,IAAM,iBAAN,cAA6B,QAAQ;AAAA,EAC1C,YAA4B,YAAoB;AAC9C,UAAM,oCAAoC,UAAU,KAAK,kBAAkB;AADjD;AAE1B,SAAK,OAAO;AAAA,EACd;AACF;AAEO,IAAM,gBAAN,cAA4B,QAAQ;AAAA,EACzC,YAAY,UAAkB,IAAY;AACxC,UAAM,GAAG,QAAQ,eAAe,EAAE,IAAI,WAAW;AACjD,SAAK,OAAO;AAAA,EACd;AACF;;;ACjDA,eAAsB,OAAO,MAA+B;AAC1D,QAAM,UAAU,IAAI,YAAY,EAAE,OAAO,IAAI;AAC7C,QAAM,SAAS,MAAM,OAAO,OAAO,OAAO,WAAW,OAAO;AAC5D,SAAO,MAAM,KAAK,IAAI,WAAW,MAAM,CAAC,EACrC,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAC1C,KAAK,EAAE;AACZ;;;ACIA,eAAsB,oBACpB,MACA,SAA2B,CAAC,GACoB;AAEhD,QAAM,SAAS,oBAAoB,UAAU,IAAI;AACjD,MAAI,CAAC,OAAO,SAAS;AACnB,UAAM,IAAI;AAAA,MACR;AAAA,MACA,OAAO,MAAM,OAAO,IAAI,CAAC,OAAO;AAAA,QAC9B,MAAM,EAAE,KAAK,KAAK,GAAG;AAAA,QACrB,SAAS,EAAE;AAAA,MACb,EAAE;AAAA,IACJ;AAAA,EACF;AAGA,QAAM,iBAAiB,MAAM,OAAO,KAAK,UAAU,IAAI,CAAC;AAExD,QAAM,MAAM,OAAO,eAAe;AAClC,QAAM,UAAkC;AAAA,IACtC,gBAAgB;AAAA,IAChB,mBAAmB;AAAA,EACrB;AACA,MAAI,OAAO,QAAQ;AACjB,YAAQ,gBAAgB,UAAU,OAAO,MAAM;AAAA,EACjD;AAEA,QAAM,MAAM,MAAM,MAAM,GAAG,GAAG,iBAAiB;AAAA,IAC7C,QAAQ;AAAA,IACR;AAAA,IACA,MAAM,KAAK,UAAU,IAAI;AAAA,EAC3B,CAAC;AAED,MAAI,CAAC,IAAI,IAAI;AACX,UAAM,OAAO,MAAM,IAAI,KAAK;AAC5B,UAAM,IAAI,kBAAkB,yBAAyB,IAAI,MAAM,IAAI,IAAI,EAAE;AAAA,EAC3E;AAEA,SAAQ,MAAM,IAAI,KAAK;AACzB;AAEA,eAAsB,gBACpB,gBACA,aAAyB,WACzB,SAA2B,CAAC,GACH;AACzB,QAAM,iBAAiB,MAAM,OAAO,cAAc;AAElD,QAAM,MAAM,OAAO,eAAe;AAClC,QAAM,UAAkC;AAAA,IACtC,gBAAgB;AAAA,IAChB,mBAAmB;AAAA,EACrB;AACA,MAAI,OAAO,QAAQ;AACjB,YAAQ,gBAAgB,UAAU,OAAO,MAAM;AAAA,EACjD;AAEA,QAAM,MAAM,MAAM,MAAM,GAAG,GAAG,cAAc;AAAA,IAC1C,QAAQ;AAAA,IACR;AAAA,IACA,MAAM,KAAK,UAAU,EAAE,kBAAkB,gBAAgB,WAAW,CAAC;AAAA,EACvE,CAAC;AAED,MAAI,CAAC,IAAI,IAAI;AACX,UAAM,OAAO,MAAM,IAAI,KAAK;AAC5B,UAAM,IAAI,kBAAkB,+BAA+B,IAAI,MAAM,IAAI,IAAI,EAAE;AAAA,EACjF;AAEA,SAAQ,MAAM,IAAI,KAAK;AACzB;AAEA,IAAM,oBAAN,cAAgC,MAAM;AAAA,EACpC,YAAY,SAAiB;AAC3B,UAAM,OAAO;AACb,SAAK,OAAO;AAAA,EACd;AACF;;;ACvFA,kBAA+D;;;ACG/D,IAAM,kBACJ;AAGF,IAAM,WAAW;AAGjB,IAAM,eAAe;AAGrB,IAAM,qBAAqB;AAAA,EACzB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAOO,SAAS,gBAAgB,SAAiC;AAC/D,QAAM,WAAqB,CAAC;AAC5B,MAAI,YAAY;AAGhB,MAAI,aAAa,KAAK,SAAS,GAAG;AAChC,aAAS,KAAK,uBAAuB;AACrC,gBAAY,UAAU,QAAQ,cAAc,EAAE;AAAA,EAChD;AAGA,MAAI,SAAS,KAAK,SAAS,GAAG;AAC5B,aAAS,KAAK,mBAAmB;AACjC,gBAAY,UAAU,QAAQ,UAAU,EAAE;AAAA,EAC5C;AAGA,MAAI,gBAAgB,KAAK,SAAS,GAAG;AACnC,UAAM,IAAI;AAAA,MACR;AAAA,IACF;AAAA,EACF;AAGA,cAAY,UAAU,UAAU,KAAK;AAGrC,aAAW,WAAW,oBAAoB;AACxC,QAAI,QAAQ,KAAK,SAAS,GAAG;AAC3B,YAAM,IAAI;AAAA,QACR,wDAAwD,QAAQ,MAAM;AAAA,MACxE;AAAA,IACF;AAAA,EACF;AAEA,SAAO,EAAE,SAAS,WAAW,SAAS;AACxC;;;ADlDA,IAAM,iBAAiB;AAEhB,SAAS,aAAa,SAAgC;AAC3D,QAAM,QAAQ,QAAQ,MAAM,cAAc;AAC1C,MAAI,CAAC,OAAO;AACV,UAAM,IAAI,gBAAgB,6DAA6D;AAAA,EACzF;AAEA,QAAM,UAAU,MAAM,CAAC;AACvB,QAAM,OAAO,MAAM,CAAC;AAEpB,MAAI;AACJ,MAAI;AACF,mBAAW,YAAAA,OAAU,OAAO;AAAA,EAC9B,SAAS,GAAG;AACV,UAAM,IAAI;AAAA,MACR,uCAAuC,aAAa,QAAQ,EAAE,UAAU,OAAO,CAAC,CAAC;AAAA,IACnF;AAAA,EACF;AAGA,QAAM,QAAQ,SAAS;AACvB,QAAM,EAAE,IAAI,GAAG,GAAG,eAAe,IAAI;AAGrC,QAAM,WAAW,yBAAyB,UAAU,cAAc;AAClE,MAAI,CAAC,SAAS,SAAS;AACrB,UAAM,IAAI;AAAA,MACR;AAAA,MACA,SAAS,MAAM,OAAO,IAAI,CAAC,OAAO;AAAA,QAChC,MAAM,EAAE,KAAK,KAAK,GAAG;AAAA,QACrB,SAAS,EAAE;AAAA,MACb,EAAE;AAAA,IACJ;AAAA,EACF;AAGA,MAAI;AACJ,MAAI,OAAO;AACT,UAAM,WAAW,yBAAyB,UAAU,KAAK;AACzD,QAAI,CAAC,SAAS,SAAS;AACrB,YAAM,IAAI;AAAA,QACR;AAAA,QACA,SAAS,MAAM,OAAO,IAAI,CAAC,OAAO;AAAA,UAChC,MAAM,MAAM,EAAE,KAAK,KAAK,GAAG,CAAC;AAAA,UAC5B,SAAS,EAAE;AAAA,QACb,EAAE;AAAA,MACJ;AAAA,IACF;AACA,SAAK,SAAS;AAAA,EAChB;AAEA,SAAO;AAAA,IACL,aAAa,SAAS;AAAA,IACtB;AAAA,IACA;AAAA,IACA,KAAK;AAAA,EACP;AACF;AAEO,SAAS,gBACd,aACA,MACA,IACQ;AACR,QAAM,WAAoC,EAAE,GAAG,YAAY;AAC3D,MAAI,IAAI;AACN,aAAS,KAAK;AAAA,EAChB;AAEA,SAAO;AAAA,MAAQ,YAAAC,WAAc,QAAQ,EAAE,KAAK,CAAC;AAAA;AAAA;AAAA,EAAY,IAAI;AAC/D;AAEO,SAAS,gBAAgB,SAAuD;AACrF,QAAM,SAAmB,CAAC;AAG1B,MAAI;AACF,UAAM,EAAE,SAAS,IAAI,gBAAgB,OAAO;AAC5C,WAAO,KAAK,GAAG,SAAS,IAAI,CAAC,MAAM,YAAY,CAAC,EAAE,CAAC;AAAA,EACrD,SAAS,GAAG;AACV,WAAO;AAAA,MACL,OAAO;AAAA,MACP,QAAQ,CAAC,aAAa,QAAQ,EAAE,UAAU,OAAO,CAAC,CAAC;AAAA,IACrD;AAAA,EACF;AAGA,MAAI;AACF,iBAAa,OAAO;AAAA,EACtB,SAAS,GAAG;AACV,QAAI,aAAa,iBAAiB;AAChC,aAAO;AAAA,QACL,OAAO;AAAA,QACP,QAAQ,CAAC,EAAE,SAAS,GAAG,EAAE,OAAO,IAAI,CAAC,MAAM,KAAK,EAAE,IAAI,KAAK,EAAE,OAAO,EAAE,CAAC;AAAA,MACzE;AAAA,IACF;AACA,WAAO;AAAA,MACL,OAAO;AAAA,MACP,QAAQ,CAAC,aAAa,QAAQ,EAAE,UAAU,OAAO,CAAC,CAAC;AAAA,IACrD;AAAA,EACF;AAEA,SAAO,EAAE,OAAO,MAAM,OAAO;AAC/B;;;AE7GO,IAAM,oBAAN,MAAwB;AAAA,EACrB,aAAa,oBAAI,IAA4B;AAAA,EAErD,SAAS,OAA6B;AACpC,UAAM,MAAM,GAAG,MAAM,IAAI,KAAK,MAAM,EAAE;AACtC,SAAK,WAAW,IAAI,KAAK,KAAK;AAAA,EAChC;AAAA,EAEA,IAAI,MAAc,IAAwC;AACxD,WAAO,KAAK,WAAW,IAAI,GAAG,IAAI,KAAK,EAAE,EAAE;AAAA,EAC7C;AAAA;AAAA,EAGA,MAAM,MAAc,IAA2B;AAC7C,UAAM,MAAqB,CAAC;AAC5B,QAAI,UAAU;AAEd,WAAO,YAAY,IAAI;AAErB,YAAM,SAAS,KAAK,IAAI,SAAS,EAAE;AACnC,UAAI,QAAQ;AACV,YAAI,KAAK,OAAO,OAAO;AACvB,eAAO;AAAA,MACT;AAGA,UAAI,QAAQ;AACZ,iBAAW,SAAS,KAAK,WAAW,OAAO,GAAG;AAC5C,YAAI,MAAM,SAAS,SAAS;AAC1B,cAAI,KAAK,MAAM,OAAO;AACtB,oBAAU,MAAM;AAChB,kBAAQ;AACR;AAAA,QACF;AAAA,MACF;AAEA,UAAI,CAAC,OAAO;AACV,cAAM,IAAI,MAAM,0BAA0B,OAAO,OAAO,EAAE,EAAE;AAAA,MAC9D;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AACF;;;AC7CO,IAAM,gBAA6B,CAAC,UAA4B;AAGrE,SAAO;AACT;;;ACPA,IAAM,WAAW,IAAI,kBAAkB;AAGvC,SAAS,SAAS,EAAE,MAAM,MAAM,IAAI,MAAM,SAAS,cAAc,CAAC;AAM3D,SAAS,QAAQ,MAAe,aAAqB,WAA4B;AACtF,MAAI,gBAAgB,UAAW,QAAO;AAEtC,QAAM,QAAQ,SAAS,MAAM,aAAa,SAAS;AACnD,MAAI,SAAS;AACb,aAAW,MAAM,OAAO;AACtB,aAAS,GAAG,MAAM;AAAA,EACpB;AACA,SAAO;AACT;;;ACnBA,IAAM,iBAAmC;AAAA,EACvC,OAAO;AAAA,EACP,SAAS;AAAA,EACT,eAAe;AAAA,EACf,eAAe;AACjB;AAaO,SAAS,kBACd,OACA,iBACkB;AAClB,QAAM,SAA2B,EAAE,GAAG,gBAAgB,GAAG,gBAAgB;AACzE,QAAM,EAAE,OAAO,SAAS,cAAc,IAAI;AAG1C,MAAI,MAAM,WAAW,GAAG;AACtB,WAAO,EAAE,QAAQ,oBAAI,IAAI,GAAG,YAAY,GAAG,WAAW,KAAK;AAAA,EAC7D;AAGA,QAAM,WAAW,oBAAI,IAAY;AACjC,aAAW,QAAQ,OAAO;AACxB,aAAS,IAAI,KAAK,WAAW;AAC7B,aAAS,IAAI,KAAK,QAAQ;AAAA,EAC5B;AACA,QAAM,SAAS,MAAM,KAAK,QAAQ;AAClC,QAAM,IAAI,OAAO;AACjB,QAAM,aAAa,oBAAI,IAAoB;AAC3C,WAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,eAAW,IAAI,OAAO,CAAC,GAAa,CAAC;AAAA,EACvC;AAIA,QAAM,WAAuB,MAAM;AAAA,IAAK,EAAE,QAAQ,EAAE;AAAA,IAAG,MACrD,IAAI,MAAc,CAAC,EAAE,KAAK,CAAC;AAAA,EAC7B;AAEA,aAAW,QAAQ,OAAO;AACxB,UAAM,OAAO,WAAW,IAAI,KAAK,WAAW;AAC5C,UAAM,KAAK,WAAW,IAAI,KAAK,QAAQ;AAGvC,QAAI,SAAS,GAAI;AAEjB,UAAM,MAAM,SAAS,IAAI;AACzB,QAAI,EAAE,IAAK,IAAI,EAAE,KAAgB,KAAK,QAAQ,IAAI;AAAA,EACpD;AAGA,QAAM,IAAgB,MAAM;AAAA,IAAK,EAAE,QAAQ,EAAE;AAAA,IAAG,MAC9C,IAAI,MAAc,CAAC,EAAE,KAAK,CAAC;AAAA,EAC7B;AAEA,WAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,UAAM,SAAS,SAAS,CAAC;AACzB,UAAM,OAAO,EAAE,CAAC;AAGhB,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,aAAO,CAAC,IAAI,KAAK,IAAI,GAAG,OAAO,CAAC,CAAW;AAAA,IAC7C;AAGA,QAAI,SAAS;AACb,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,gBAAU,OAAO,CAAC;AAAA,IACpB;AAGA,QAAI,SAAS,GAAG;AACd,eAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,aAAK,CAAC,IAAK,OAAO,CAAC,IAAe;AAAA,MACpC;AAAA,IACF,OAAO;AAEL,eAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,aAAK,CAAC,IAAI,IAAI;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAGA,QAAM,IAAI,IAAI,MAAc,CAAC,EAAE,KAAK,IAAI,CAAC;AAMzC,QAAM,aAAa,IAAI,MAAc,CAAC,EAAE,KAAK,CAAC;AAC9C,MAAI,WAAW;AACf,WAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,YAAM,SAAS,SAAS,CAAC;AACzB,iBAAW,CAAC,IAAK,WAAW,CAAC,IAAgB,OAAO,CAAC;AAAA,IACvD;AACA,gBAAY,WAAW,CAAC;AAAA,EAC1B;AACA,MAAI;AACJ,MAAI,WAAW,GAAG;AAChB,QAAI,WAAW,IAAI,CAAC,MAAc,IAAI,QAAQ;AAAA,EAChD,OAAO;AACL,QAAI,IAAI,MAAc,CAAC,EAAE,KAAK,IAAI,CAAC;AAAA,EACrC;AACA,MAAI,aAAa;AACjB,MAAI,YAAY;AAEhB,WAAS,OAAO,GAAG,OAAO,eAAe,QAAQ;AAC/C,iBAAa,OAAO;AAGpB,UAAM,KAAK,IAAI,MAAc,CAAC,EAAE,KAAK,CAAC;AACtC,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,eAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,cAAM,OAAO,EAAE,CAAC;AAChB,WAAG,CAAC,IAAK,GAAG,CAAC,IAAgB,KAAK,CAAC,IAAgB,EAAE,CAAC;AAAA,MACxD;AAAA,IACF;AAGA,UAAM,QAAQ,IAAI,MAAc,CAAC;AACjC,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,YAAM,CAAC,KACJ,IAAI,SAAU,GAAG,CAAC,IAAe,QAAS,EAAE,CAAC;AAAA,IAClD;AAGA,QAAI,UAAU;AACd,aAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,gBAAU,KAAK;AAAA,QACb;AAAA,QACA,KAAK,IAAK,MAAM,CAAC,IAAgB,EAAE,CAAC,CAAY;AAAA,MAClD;AAAA,IACF;AAEA,QAAI;AAEJ,QAAI,UAAU,SAAS;AACrB,kBAAY;AACZ;AAAA,IACF;AAAA,EACF;AAGA,QAAM,SAAS,oBAAI,IAAoB;AACvC,WAAS,IAAI,GAAG,IAAI,GAAG,KAAK;AAC1B,WAAO,IAAI,OAAO,CAAC,GAAa,EAAE,CAAC,CAAW;AAAA,EAChD;AAEA,SAAO,EAAE,QAAQ,YAAY,UAAU;AACzC;;;AC1JA,cAAyB;AACzB,kBAAuB;AAIf,eAAO,SAAS,CAAC,YACvB,oBAAO,GAAG;AAUZ,eAAsB,kBAAoC;AACxD,QAAM,aAAqB,cAAM,gBAAgB;AACjD,QAAM,YAAY,MAAc,0BAAkB,UAAU;AAC5D,SAAO,EAAE,WAAW,WAAW;AACjC;AAKO,SAAS,iBAAiB,MAOR;AACvB,QAAM,aAAmC;AAAA,IACvC,YAAY;AAAA,MACV;AAAA,MACA;AAAA,IACF;AAAA,IACA,MAAM,CAAC,wBAAwB,wBAAwB;AAAA,IACvD,QAAQ,KAAK;AAAA,IACb,eAAc,oBAAI,KAAK,GAAE,YAAY;AAAA,IACrC,mBAAmB;AAAA,MACjB,IAAI,KAAK;AAAA,MACT,OAAO,KAAK;AAAA,MACZ,eAAe,KAAK;AAAA,MACpB,aAAa,KAAK;AAAA,IACpB;AAAA,EACF;AAEA,MAAI,KAAK,WAAW,QAAW;AAC7B,eAAW,kBAAkB,SAAS,KAAK;AAAA,EAC7C;AAEA,SAAO;AACT;AAMA,SAAS,aAAa,IAAkC;AAEtD,QAAM,EAAE,OAAO,GAAG,KAAK,IAAI;AAC3B,SAAO,KAAK,UAAU,IAAI;AAC5B;AAMA,eAAsB,eACpB,IACA,YACA,oBAC+B;AAC/B,QAAM,YAAY,aAAa,EAAE;AACjC,QAAM,UAAU,IAAI,YAAY,EAAE,OAAO,SAAS;AAClD,QAAM,YAAY,MAAc,kBAAU,SAAS,UAAU;AAG7D,QAAM,aAAa,cAAc,SAAS;AAE1C,SAAO;AAAA,IACL,GAAG;AAAA,IACH,OAAO;AAAA,MACL,MAAM;AAAA,MACN,UAAS,oBAAI,KAAK,GAAE,YAAY;AAAA,MAChC;AAAA,MACA,cAAc;AAAA,MACd;AAAA,IACF;AAAA,EACF;AACF;AAMA,eAAsB,iBACpB,IACA,WACkB;AAClB,MAAI,CAAC,GAAG,OAAO;AACb,WAAO;AAAA,EACT;AAEA,QAAM,YAAY,aAAa,EAAE;AACjC,QAAM,UAAU,IAAI,YAAY,EAAE,OAAO,SAAS;AAClD,QAAM,YAAY,cAAc,GAAG,MAAM,UAAU;AAEnD,MAAI;AACF,WAAO,MAAc,oBAAY,WAAW,SAAS,SAAS;AAAA,EAChE,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAIA,SAAS,cAAc,OAA2B;AAChD,MAAI,SAAS;AACb,WAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,cAAU,OAAO,aAAa,MAAM,CAAC,CAAW;AAAA,EAClD;AACA,SAAO,KAAK,MAAM;AACpB;AAEA,SAAS,cAAc,QAA4B;AACjD,QAAM,SAAS,KAAK,MAAM;AAC1B,QAAM,QAAQ,IAAI,WAAW,OAAO,MAAM;AAC1C,WAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACtC,UAAM,CAAC,IAAI,OAAO,WAAW,CAAC;AAAA,EAChC;AACA,SAAO;AACT;","names":["parseYaml","stringifyYaml"]}