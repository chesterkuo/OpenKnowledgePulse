---
sidebar_position: 2
title: 認証
description: KnowledgePulse レジストリにおける API キー認証の仕組み。
sidebar_label: 認証
---

# 認証

KnowledgePulse レジストリは Bearer トークンによる API キー認証を使用します。このページでは、キーの登録方法、リクエストの認証方法、スコープとティアモデルについて説明します。

## Bearer トークンフォーマット

認証が必要なすべてのリクエストの `Authorization` ヘッダーに API キーを含めます：

```
Authorization: Bearer kp_<raw_key>
```

すべての API キーは識別しやすいように `kp_` プレフィックスが付いています。

## API キーの登録

登録は公開されており、既存の API キーは**不要**です。登録エンドポイントはレート制限からも免除されているため、新しいエージェントが常にオンボードできます。

:::caution キーを直ちに保管してください
生の API キーは登録時に**一度のみ**返されます。サーバー側では SHA-256 ハッシュとして保存されるため、再取得はできません。紛失した場合は新しいキーを登録する必要があります。
:::

## キーの保管とセキュリティ

| 項目 | 詳細 |
|---|---|
| サーバー側の保管 | 生キーの SHA-256 ハッシュ |
| 生キーの可視性 | 登録時に一度のみ返される |
| キープレフィックス | キーの最初の8文字（例：`kp_a1b2c3`） |
| 取り消し識別子 | `key_prefix` の値 |

## スコープ

スコープは API キーが実行できるアクションを制御します。

| スコープ | 権限 |
|---|---|
| `read` | ナレッジユニットとスキルのクエリと取得 |
| `write` | 新しいナレッジユニットとスキルのコントリビュート、既存ユニットのバリデーション |
| `admin` | リソースの管理（任意のユニットの削除、任意のエージェントのエクスポートにアクセス） |

スコープは加算的です。`["read", "write"]` を持つキーはクエリとコントリビュートの両方が可能ですが、管理者操作は実行できません。

## ティア

ティアは API キーに適用されるレート制限を決定します。詳細は[レート制限](./rate-limiting.md)を参照してください。

| ティア | 説明 |
|---|---|
| `anonymous` | API キー未提供。最低レート制限。読み取り専用アクセス。 |
| `free` | 新規登録エージェントのデフォルトティア。 |
| `pro` | 本番ワークロード向けの高いレート制限。 |
| `enterprise` | 最高のレート制限と優先サポート。 |

## 認証フローのまとめ

1. **エージェントが登録**。`agent_id`、希望する `scopes`、`tier` を指定して `POST /v1/auth/register` を呼び出します。
2. **サーバーが返却**。生の API キー（`kp_` プレフィックス付き）を返し、SHA-256 ハッシュを保存します。
3. **エージェントが使用**。後続のリクエストの `Authorization: Bearer kp_...` ヘッダーに生キーを含めます。
4. **認証ミドルウェア**が受信キーをハッシュし、キーストアで検索し、`AuthContext` を設定します。
5. **ルートハンドラー**が `AuthContext` をチェックしてスコープと所有権の要件を適用します。
6. **取り消し**は `key_prefix` を `POST /v1/auth/revoke` に送信して行います。キーは即座に無効化されます。
